"use strict";var e=require("serialport"),t=require("stream"),r=require("node:util"),o=require("node:process"),n=require("node:os"),i=require("node:tty"),s=require("node:events"),l=require("node:buffer"),a=require("crypto"),c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},h={},u={};Object.defineProperty(u,"__esModule",{value:!0}),u.SlipDecoder=void 0;const f=t;class g extends f.Transform{constructor(e={}){super(e);const{START:t,ESC:r=219,END:o=192,ESC_START:n,ESC_END:i=220,ESC_ESC:s=221}=e;this.opts={START:t,ESC:r,END:o,ESC_START:n,ESC_END:i,ESC_ESC:s},this.buffer=Buffer.alloc(0),this.escape=!1,this.start=!1}_transform(e,t,r){for(let t=0;t<e.length;t++){let r=e[t];if(r!==this.opts.START){if(null==this.opts.START&&(this.start=!0),this.escape)r===this.opts.ESC_START&&this.opts.START?r=this.opts.START:r===this.opts.ESC_ESC?r=this.opts.ESC:r===this.opts.ESC_END?r=this.opts.END:(this.escape=!1,this.push(this.buffer),this.buffer=Buffer.alloc(0));else{if(r===this.opts.ESC){this.escape=!0;continue}if(r===this.opts.END){this.push(this.buffer),this.buffer=Buffer.alloc(0),this.escape=!1,this.start=!1;continue}}this.escape=!1,this.start&&(this.buffer=Buffer.concat([this.buffer,Buffer.from([r])]))}else this.start=!0}r()}_flush(e){this.push(this.buffer),this.buffer=Buffer.alloc(0),e()}}u.SlipDecoder=g;var d={};Object.defineProperty(d,"__esModule",{value:!0}),d.SlipEncoder=void 0;const p=t;class E extends p.Transform{constructor(e={}){super(e);const{START:t,ESC:r=219,END:o=192,ESC_START:n,ESC_END:i=220,ESC_ESC:s=221,bluetoothQuirk:l=!1}=e;this.opts={START:t,ESC:r,END:o,ESC_START:n,ESC_END:i,ESC_ESC:s,bluetoothQuirk:l}}_transform(e,t,r){const o=e.length;if(this.opts.bluetoothQuirk&&0===o)return r();const n=Buffer.alloc(2*o+2);let i=0;1==this.opts.bluetoothQuirk&&(n[i++]=this.opts.END),void 0!==this.opts.START&&(n[i++]=this.opts.START);for(let t=0;t<o;t++){let r=e[t];r===this.opts.START&&this.opts.ESC_START?(n[i++]=this.opts.ESC,r=this.opts.ESC_START):r===this.opts.END?(n[i++]=this.opts.ESC,r=this.opts.ESC_END):r===this.opts.ESC&&(n[i++]=this.opts.ESC,r=this.opts.ESC_ESC),n[i++]=r}n[i++]=this.opts.END,r(null,n.slice(0,i))}}function b(e){return null!==e&&"object"==typeof e}function T(e,t,r=".",o){if(!b(t))return T(e,{},r,o);const n=Object.assign({},t);for(const t in e){if("__proto__"===t||"constructor"===t)continue;const i=e[t];null!=i&&(o&&o(n,t,i,r)||(Array.isArray(i)&&Array.isArray(n[t])?n[t]=[...i,...n[t]]:b(i)&&b(n[t])?n[t]=T(i,n[t],(r?`${r}.`:"")+t.toString(),o):n[t]=i))}return n}d.SlipEncoder=E,function(e){var t=c&&c.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),r=c&&c.__exportStar||function(e,r){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(r,o)||t(r,e,o)};Object.defineProperty(e,"__esModule",{value:!0}),r(u,e),r(d,e)}(h);const m=(...e)=>e.reduce(((e,t)=>T(e,t,"",undefined)),{});const v=(e=0)=>t=>`[${t+e}m`,S=(e=0)=>t=>`[${38+e};5;${t}m`,R=(e=0)=>(t,r,o)=>`[${38+e};2;${t};${r};${o}m`,A={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(A.modifier),Object.keys(A.color),Object.keys(A.bgColor);const C=function(){const e=new Map;for(const[t,r]of Object.entries(A)){for(const[t,o]of Object.entries(r))A[t]={open:`[${o[0]}m`,close:`[${o[1]}m`},r[t]=A[t],e.set(o[0],o[1]);Object.defineProperty(A,t,{value:r,enumerable:!1})}return Object.defineProperty(A,"codes",{value:e,enumerable:!1}),A.color.close="[39m",A.bgColor.close="[49m",A.color.ansi=v(),A.color.ansi256=S(),A.color.ansi16m=R(),A.bgColor.ansi=v(10),A.bgColor.ansi256=S(10),A.bgColor.ansi16m=R(10),Object.defineProperties(A,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value(e){const t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(e.toString(16));if(!t)return[0,0,0];let[r]=t;3===r.length&&(r=[...r].map((e=>e+e)).join(""));const o=Number.parseInt(r,16);return[o>>16&255,o>>8&255,255&o]},enumerable:!1},hexToAnsi256:{value:e=>A.rgbToAnsi256(...A.hexToRgb(e)),enumerable:!1},ansi256ToAnsi:{value(e){if(e<8)return 30+e;if(e<16)return e-8+90;let t,r,o;if(e>=232)t=(10*(e-232)+8)/255,r=t,o=t;else{const n=(e-=16)%36;t=Math.floor(e/36)/5,r=Math.floor(n/6)/5,o=n%6/5}const n=2*Math.max(t,r,o);if(0===n)return 30;let i=30+(Math.round(o)<<2|Math.round(r)<<1|Math.round(t));return 2===n&&(i+=60),i},enumerable:!1},rgbToAnsi:{value:(e,t,r)=>A.ansi256ToAnsi(A.rgbToAnsi256(e,t,r)),enumerable:!1},hexToAnsi:{value:e=>A.ansi256ToAnsi(A.hexToAnsi256(e)),enumerable:!1}}),A}();function O(e,t=(globalThis.Deno?globalThis.Deno.args:o.argv)){const r=e.startsWith("-")?"":1===e.length?"-":"--",n=t.indexOf(r+e),i=t.indexOf("--");return-1!==n&&(-1===i||n<i)}const{env:y}=o;let _;function P(e,{streamIsTTY:t,sniffFlags:r=!0}={}){const i=function(){if("FORCE_COLOR"in y)return"true"===y.FORCE_COLOR?1:"false"===y.FORCE_COLOR?0:0===y.FORCE_COLOR.length?1:Math.min(Number.parseInt(y.FORCE_COLOR,10),3)}();void 0!==i&&(_=i);const s=r?_:i;if(0===s)return 0;if(r){if(O("color=16m")||O("color=full")||O("color=truecolor"))return 3;if(O("color=256"))return 2}if("TF_BUILD"in y&&"AGENT_NAME"in y)return 1;if(e&&!t&&void 0===s)return 0;const l=s||0;if("dumb"===y.TERM)return l;if("win32"===o.platform){const e=n.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in y)return"GITHUB_ACTIONS"in y?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some((e=>e in y))||"codeship"===y.CI_NAME?1:l;if("TEAMCITY_VERSION"in y)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(y.TEAMCITY_VERSION)?1:0;if("truecolor"===y.COLORTERM)return 3;if("xterm-kitty"===y.TERM)return 3;if("TERM_PROGRAM"in y){const e=Number.parseInt((y.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(y.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(y.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(y.TERM)||"COLORTERM"in y?1:l}function D(e,t={}){return function(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}(P(e,{streamIsTTY:e&&e.isTTY,...t}))}O("no-color")||O("no-colors")||O("color=false")||O("color=never")?_=0:(O("color")||O("colors")||O("color=true")||O("color=always"))&&(_=1);const N={stdout:D({isTTY:i.isatty(1)}),stderr:D({isTTY:i.isatty(2)})};function I(e,t,r){let o=e.indexOf(t);if(-1===o)return e;const n=t.length;let i=0,s="";do{s+=e.slice(i,o)+t+r,i=o+n,o=e.indexOf(t,i)}while(-1!==o);return s+=e.slice(i),s}const{stdout:w,stderr:M}=N,L=Symbol("GENERATOR"),B=Symbol("STYLER"),x=Symbol("IS_EMPTY"),k=["ansi","ansi","ansi256","ansi16m"],G=Object.create(null);function j(e){return(e=>{const t=(...e)=>e.join(" ");return((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const r=w?w.level:0;e.level=void 0===t.level?r:t.level})(t,e),Object.setPrototypeOf(t,j.prototype),t})(e)}Object.setPrototypeOf(j.prototype,Function.prototype);for(const[e,t]of Object.entries(C))G[e]={get(){const r=U(this,F(t.open,t.close,this[B]),this[x]);return Object.defineProperty(this,e,{value:r}),r}};G.visible={get(){const e=U(this,this[B],!0);return Object.defineProperty(this,"visible",{value:e}),e}};const $=(e,t,r,...o)=>"rgb"===e?"ansi16m"===t?C[r].ansi16m(...o):"ansi256"===t?C[r].ansi256(C.rgbToAnsi256(...o)):C[r].ansi(C.rgbToAnsi(...o)):"hex"===e?$("rgb",t,r,...C.hexToRgb(...o)):C[r][e](...o),Y=["rgb","hex","ansi256"];for(const e of Y)G[e]={get(){const{level:t}=this;return function(...r){const o=F($(e,k[t],"color",...r),C.color.close,this[B]);return U(this,o,this[x])}}},G["bg"+e[0].toUpperCase()+e.slice(1)]={get(){const{level:t}=this;return function(...r){const o=F($(e,k[t],"bgColor",...r),C.bgColor.close,this[B]);return U(this,o,this[x])}}};const H=Object.defineProperties((()=>{}),{...G,level:{enumerable:!0,get(){return this[L].level},set(e){this[L].level=e}}}),F=(e,t,r)=>{let o,n;return void 0===r?(o=e,n=t):(o=r.openAll+e,n=t+r.closeAll),{open:e,close:t,openAll:o,closeAll:n,parent:r}},U=(e,t,r)=>{const o=(...e)=>V(o,1===e.length?""+e[0]:e.join(" "));return Object.setPrototypeOf(o,H),o[L]=e,o[B]=t,o[x]=r,o},V=(e,t)=>{if(e.level<=0||!t)return e[x]?"":t;let r=e[B];if(void 0===r)return t;const{openAll:o,closeAll:n}=r;if(t.includes(""))for(;void 0!==r;)t=I(t,r.close,r.open),r=r.parent;const i=t.indexOf("\n");return-1!==i&&(t=function(e,t,r,o){let n=0,i="";do{const s="\r"===e[o-1];i+=e.slice(n,s?o-1:o)+t+(s?"\r\n":"\n")+r,n=o+1,o=e.indexOf("\n",n)}while(-1!==o);return i+=e.slice(n),i}(t,n,o,i)),o+t+n};Object.defineProperties(j.prototype,G);const q=j();j({level:M?M.level:0});const K={all:0,debug:1,deviceEvent:2,info:3,warn:4,error:5,fatal:98,none:99},W={host:"",logLevel:"all",prompt:" => ",showTime:!1,symbol:{debug:"dbg",info:"",deviceEvent:"",warn:"(!)",error:"[!]",fatal:"{x_X}"},terminal:!0},Q={debug:q.gray,info:q.white,deviceEvent:q.green,warn:q.yellow,error:q.red,fatal:q.redBright};function X(e,t){return r.inspect(e,{colors:!0,depth:t})}function z(e){return r.inspect(e,{colors:!0,depth:2})}class J{_debug=()=>{};_info=()=>{};_deviceEvent=()=>{};_warn=()=>{};_error=()=>{};_fatal=()=>{};_defaultLogger(e,t){console.log(e)}prompt=" => ";host="";logLevel="all";terminal=!0;showTime=!1;showMillis=!1;get time(){const e=new Date;let t="",r="",o="";e.getHours()<10&&(t="0"),e.getMinutes()<10&&(r="0"),e.getSeconds()<10&&(o="0"),t+=e.getHours(),r+=e.getMinutes(),o+=e.getSeconds();let n=t+":"+r+":"+o;return this.showMillis&&(n+=":"+e.getMilliseconds()),q.grey(n)}ps(e){let t="";return!0===this.showTime&&(t+=this.time+" "),""!==this.symbol[e]&&(t+=Q[e](this.symbol[e])+" "),t+=Q[e](this.host)+this.prompt,t}symbol;assignOptions(e,t){for(const r in t)"object"!=typeof e[r]?e[r]=t[r]||e[r]:this.assignOptions(e[r],t[r])}getLevelLoggers(){return{debug:this._debug,info:this._info,deviceEvent:this._deviceEvent,warn:this._warn,error:this._error,fatal:this._fatal}}logger=this._defaultLogger;resetLogger(){this.logger=this._defaultLogger}constructor(e=W){const t=m(e,W);this.assignOptions(this,t),this.spawnLevelLoggers()}spawnLevelLoggers(){for(let e in this.symbol){let t=e;this["_"+e]=e=>{let r=`${this.ps(t)}${o=e,"string"==typeof o?o:z(o)}`;var o;return K[this.logLevel]<=K[t]&&this.logger(r,t),r}}}}const Z=/(^|[/\\])([^/\\]+?)(?=(\.[^.]+)?$)/;let ee,te,re=(e=21)=>{var t;t=e-=0,!ee||ee.length<t?(ee=Buffer.allocUnsafe(128*t),a.randomFillSync(ee),te=0):te+t>ee.length&&(a.randomFillSync(ee),te=0),te+=t;let r="";for(let t=te-e;t<te;t++)r+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&ee[t]];return r};const oe=(e=0)=>t=>`[${t+e}m`,ne=(e=0)=>t=>`[${38+e};5;${t}m`,ie=(e=0)=>(t,r,o)=>`[${38+e};2;${t};${r};${o}m`,se={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(se.modifier);Object.keys(se.color),Object.keys(se.bgColor);const le=function(){const e=new Map;for(const[t,r]of Object.entries(se)){for(const[t,o]of Object.entries(r))se[t]={open:`[${o[0]}m`,close:`[${o[1]}m`},r[t]=se[t],e.set(o[0],o[1]);Object.defineProperty(se,t,{value:r,enumerable:!1})}return Object.defineProperty(se,"codes",{value:e,enumerable:!1}),se.color.close="[39m",se.bgColor.close="[49m",se.color.ansi=oe(),se.color.ansi256=ne(),se.color.ansi16m=ie(),se.bgColor.ansi=oe(10),se.bgColor.ansi256=ne(10),se.bgColor.ansi16m=ie(10),Object.defineProperties(se,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value(e){const t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(e.toString(16));if(!t)return[0,0,0];let[r]=t;3===r.length&&(r=[...r].map((e=>e+e)).join(""));const o=Number.parseInt(r,16);return[o>>16&255,o>>8&255,255&o]},enumerable:!1},hexToAnsi256:{value:e=>se.rgbToAnsi256(...se.hexToRgb(e)),enumerable:!1},ansi256ToAnsi:{value(e){if(e<8)return 30+e;if(e<16)return e-8+90;let t,r,o;if(e>=232)t=(10*(e-232)+8)/255,r=t,o=t;else{const n=(e-=16)%36;t=Math.floor(e/36)/5,r=Math.floor(n/6)/5,o=n%6/5}const n=2*Math.max(t,r,o);if(0===n)return 30;let i=30+(Math.round(o)<<2|Math.round(r)<<1|Math.round(t));return 2===n&&(i+=60),i},enumerable:!1},rgbToAnsi:{value:(e,t,r)=>se.ansi256ToAnsi(se.rgbToAnsi256(e,t,r)),enumerable:!1},hexToAnsi:{value:e=>se.ansi256ToAnsi(se.hexToAnsi256(e)),enumerable:!1}}),se}();function ae(e,t=(globalThis.Deno?globalThis.Deno.args:o.argv)){const r=e.startsWith("-")?"":1===e.length?"-":"--",n=t.indexOf(r+e),i=t.indexOf("--");return-1!==n&&(-1===i||n<i)}const{env:ce}=o;let he;function ue(e,{streamIsTTY:t,sniffFlags:r=!0}={}){const i=function(){if("FORCE_COLOR"in ce)return"true"===ce.FORCE_COLOR?1:"false"===ce.FORCE_COLOR?0:0===ce.FORCE_COLOR.length?1:Math.min(Number.parseInt(ce.FORCE_COLOR,10),3)}();void 0!==i&&(he=i);const s=r?he:i;if(0===s)return 0;if(r){if(ae("color=16m")||ae("color=full")||ae("color=truecolor"))return 3;if(ae("color=256"))return 2}if("TF_BUILD"in ce&&"AGENT_NAME"in ce)return 1;if(e&&!t&&void 0===s)return 0;const l=s||0;if("dumb"===ce.TERM)return l;if("win32"===o.platform){const e=n.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in ce)return"GITHUB_ACTIONS"in ce?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some((e=>e in ce))||"codeship"===ce.CI_NAME?1:l;if("TEAMCITY_VERSION"in ce)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(ce.TEAMCITY_VERSION)?1:0;if("truecolor"===ce.COLORTERM)return 3;if("xterm-kitty"===ce.TERM)return 3;if("TERM_PROGRAM"in ce){const e=Number.parseInt((ce.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(ce.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(ce.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(ce.TERM)||"COLORTERM"in ce?1:l}function fe(e,t={}){return function(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}(ue(e,{streamIsTTY:e&&e.isTTY,...t}))}ae("no-color")||ae("no-colors")||ae("color=false")||ae("color=never")?he=0:(ae("color")||ae("colors")||ae("color=true")||ae("color=always"))&&(he=1);const ge={stdout:fe({isTTY:i.isatty(1)}),stderr:fe({isTTY:i.isatty(2)})};function de(e,t,r){let o=e.indexOf(t);if(-1===o)return e;const n=t.length;let i=0,s="";do{s+=e.slice(i,o)+t+r,i=o+n,o=e.indexOf(t,i)}while(-1!==o);return s+=e.slice(i),s}const{stdout:pe,stderr:Ee}=ge,be=Symbol("GENERATOR"),Te=Symbol("STYLER"),me=Symbol("IS_EMPTY"),ve=["ansi","ansi","ansi256","ansi16m"],Se=Object.create(null),Re=e=>{const t=(...e)=>e.join(" ");return((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const r=pe?pe.level:0;e.level=void 0===t.level?r:t.level})(t,e),Object.setPrototypeOf(t,Ae.prototype),t};function Ae(e){return Re(e)}Object.setPrototypeOf(Ae.prototype,Function.prototype);for(const[e,t]of Object.entries(le))Se[e]={get(){const r=Pe(this,_e(t.open,t.close,this[Te]),this[me]);return Object.defineProperty(this,e,{value:r}),r}};Se.visible={get(){const e=Pe(this,this[Te],!0);return Object.defineProperty(this,"visible",{value:e}),e}};const Ce=(e,t,r,...o)=>"rgb"===e?"ansi16m"===t?le[r].ansi16m(...o):"ansi256"===t?le[r].ansi256(le.rgbToAnsi256(...o)):le[r].ansi(le.rgbToAnsi(...o)):"hex"===e?Ce("rgb",t,r,...le.hexToRgb(...o)):le[r][e](...o),Oe=["rgb","hex","ansi256"];for(const e of Oe){Se[e]={get(){const{level:t}=this;return function(...r){const o=_e(Ce(e,ve[t],"color",...r),le.color.close,this[Te]);return Pe(this,o,this[me])}}};Se["bg"+e[0].toUpperCase()+e.slice(1)]={get(){const{level:t}=this;return function(...r){const o=_e(Ce(e,ve[t],"bgColor",...r),le.bgColor.close,this[Te]);return Pe(this,o,this[me])}}}}const ye=Object.defineProperties((()=>{}),{...Se,level:{enumerable:!0,get(){return this[be].level},set(e){this[be].level=e}}}),_e=(e,t,r)=>{let o,n;return void 0===r?(o=e,n=t):(o=r.openAll+e,n=t+r.closeAll),{open:e,close:t,openAll:o,closeAll:n,parent:r}},Pe=(e,t,r)=>{const o=(...e)=>De(o,1===e.length?""+e[0]:e.join(" "));return Object.setPrototypeOf(o,ye),o[be]=e,o[Te]=t,o[me]=r,o},De=(e,t)=>{if(e.level<=0||!t)return e[me]?"":t;let r=e[Te];if(void 0===r)return t;const{openAll:o,closeAll:n}=r;if(t.includes(""))for(;void 0!==r;)t=de(t,r.close,r.open),r=r.parent;const i=t.indexOf("\n");return-1!==i&&(t=function(e,t,r,o){let n=0,i="";do{const s="\r"===e[o-1];i+=e.slice(n,s?o-1:o)+t+(s?"\r\n":"\n")+r,n=o+1,o=e.indexOf("\n",n)}while(-1!==o);return i+=e.slice(n),i}(t,n,o,i)),o+t+n};Object.defineProperties(Ae.prototype,Se);const Ne=Ae();function Ie(e){return null!==e&&"object"==typeof e}function we(e,t,r=".",o){if(!Ie(t))return we(e,{},r,o);const n=Object.assign({},t);for(const t in e){if("__proto__"===t||"constructor"===t)continue;const i=e[t];null!=i&&(o&&o(n,t,i,r)||(Array.isArray(i)&&Array.isArray(n[t])?n[t]=[...i,...n[t]]:Ie(i)&&Ie(n[t])?n[t]=we(i,n[t],(r?`${r}.`:"")+t.toString(),o):n[t]=i))}return n}Ae({level:Ee?Ee.level:0});const Me=(...e)=>e.reduce(((e,t)=>we(e,t,"",Le)),{});var Le;let Be=0;var xe;exports.PacketType=void 0,(xe=exports.PacketType||(exports.PacketType={}))[xe.PING=0]="PING",xe[xe.ACK=1]="ACK",xe[xe.READY=2]="READY",xe[xe.STATE_UPDATE=3]="STATE_UPDATE",xe[xe.ERROR=4]="ERROR",xe[xe.STRING=5]="STRING",xe[xe.DISCONNECT=6]="DISCONNECT";const ke={portInfo:{},logLevel:"all",id:"",showTime:!1};class Ge extends s.EventEmitter{serialPort;slipEncoder=new h.SlipEncoder(Fe);slipDecoder=new h.SlipDecoder(Fe);_prevAckTime=0;prevState={buttons:[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],dials:[0,0,0,0]};_deviceReady=!1;_id="";_portInfo=null;_msger;keepAliveTimer;get prevAckTime(){return this._prevAckTime}get isOpen(){return void 0!==this.serialPort&&this.serialPort.isOpen}static get connectedDevices(){return Be}get devicePath(){return null!==this._portInfo?this._portInfo.path:""}get deviceSerial(){return null!==this._portInfo?this._portInfo.serialNumber:""}get fingerPrint(){return{devicePath:this.devicePath,deviceSerial:this.deviceSerial,portId:this.portId}}get portInfo(){return this._portInfo}get portId(){return this._id}log;debug;deviceEvent;info;warn;error;fatal;get host(){let e=`Port:${Ne.magenta(this.deviceSerial.slice(0,4))}|`;var t;return this.isOpen?e+=Ne.green((t=this.devicePath,t.match(Z)?.[2])):e+=Ne.yellow("D/C"),e}_logLevel="all";get showTime(){return this._msger.showTime}set showTime(e){this._msger.showTime=e}get logLevel(){return this._logLevel}set logLevel(e){this._logLevel=e,this._msger.logLevel=e}get logTermFormat(){return this._msger.terminal}set logTermFormat(e){this._msger.terminal=e}emitLog=(e,t)=>{this.emit(je.Terminal.Log[t],{level:t,message:e,buffer:l.Buffer.from(e)})};constructor(e){super();const t=Me(e,ke);this._id=""===t.id?re(23):t.id,this._portInfo=t.portInfo,this._msger=new J,this._msger.host=this.host,this._msger.showTime=t.showTime,this.log=this._msger.getLevelLoggers(),this.logLevel=t.logLevel;for(const e in this.log)this[e]=t=>{const r=this.log[e](t);this.emitLog(r,e)};this.debug("Creating new MakeShiftPort with options: "+z(t)),this.slipDecoder.on("data",(e=>{this.parseSlipPacketHeader(e)})),this.open()}parseSlipPacketHeader(e){this._prevAckTime=Date.now();const t=e.subarray(0,1).at(0),r=e.subarray(1);switch(this.debug(e),t){case exports.PacketType.STATE_UPDATE:{let e=Ge.parseStateFromBuffer(r);this.emit(je.DEVICE.STATE_UPDATE,e),this.handleStateUpdate(e);break}case exports.PacketType.ACK:this.debug("Got ACK from MakeShift");break;case exports.PacketType.STRING:this.debug(r.toString());break;case exports.PacketType.PING:this.debug("Got PING from MakeShift, responding with ACK"),this.sendByte(exports.PacketType.ACK);break;case exports.PacketType.ERROR:this.debug("Got ERROR from MakeShift");break;case exports.PacketType.READY:this.debug("Got READY from MakeShift"),this.debug(r.toString()),Be++,this._deviceReady=!0,this._prevAckTime=Date.now(),this.deviceEvent("Device connection established"),this.emit(je.DEVICE.CONNECTED,this.fingerPrint);break;default:this.debug(t),this.debug(e.toString())}}ping(){this.sendByte(exports.PacketType.PING)}handleStateUpdate(e){for(let t=0;t<Ye;t++)if(e.buttons[t]!=this.prevState.buttons[t]){let r;r=!0===e.buttons[t]?je.BUTTON[t].PRESSED:je.BUTTON[t].RELEASED,this.emit(r,{state:e.buttons[t],event:r}),this.deviceEvent(`${r} with state ${e.buttons[t]}`)}let t;for(let r=0;r<He;r++)if(t=e.dials[r]-this.prevState.dials[r],0!==t){let o;this.emit(je.DIAL[r].CHANGE,{state:e.dials[r],event:o}),o=t>0?je.DIAL[r].INCREMENT:je.DIAL[r].DECREMENT,this.emit(o,{state:e.dials[r],event:o}),this.deviceEvent(`${o} with state ${e.dials[r]}`)}this.prevState=e}sendByte(e){if(this.isOpen)try{this.serialPort.flush();let t=l.Buffer.from([e]);this.debug(`Sending byte: ${z(t)}`),this.slipEncoder.write(t)}catch(e){this.error(e)}}send(e,t){if(this.isOpen)try{this.serialPort.flush();let r=l.Buffer.from([e]),o=l.Buffer.from(t);const n=l.Buffer.concat([r,o]);this.debug(`Sending buffer: ${z(n)}`),this.slipEncoder.write(n)}catch(e){this.error(e)}}static parseStateFromBuffer(e){let t={buttons:[],dials:[]};const r=e.subarray(0,2).reverse(),o=e.subarray(2,18);function n(e,r){0!==r&&(e%2?t.buttons.push(!0):t.buttons.push(!1),n(Math.floor(e/2),r-1))}return r.forEach((e=>n(e,8))),t.dials.push(o.readInt32BE(0)),t.dials.push(o.readInt32BE(4)),t.dials.push(o.readInt32BE(8)),t.dials.push(o.readInt32BE(12)),t}async open(){this.serialPort=await new e.SerialPort({path:this.devicePath,baudRate:42069},(e=>{null!=e?(this.error("Something happened while opening port: "),this.error(e)):(this._msger.host=this.host,this.info("SerialPort opened, attaching SLIP translators"),this.slipEncoder.pipe(this.serialPort),this.serialPort.pipe(this.slipDecoder),this.info("Translators ready, sending READY to MakeShift"),this.sendByte(exports.PacketType.READY))}))}close(){this.info("Closing MakeShift port..."),this.info("Unpiping encoders"),this.slipEncoder.unpipe(),this.serialPort.unpipe(),this.isOpen&&(this.info("Port object found open"),this.info("Sending disconnect packet"),this.sendByte(exports.PacketType.DISCONNECT),this.info("Closing port"),this.serialPort.close()),this._msger.host=this.host,Be--,this._deviceReady=!1,this.warn("Port closed, sending disconnect signal"),this.emit(je.DEVICE.DISCONNECTED,this.fingerPrint)}write=e=>{this._deviceReady?this.send(exports.PacketType.STRING,e):this.info("MakeShift not ready, line not sent")}}const je={DIAL:[{INCREMENT:"dial-01-increment",DECREMENT:"dial-01-decrement",CHANGE:"dial-01-change"},{INCREMENT:"dial-02-increment",DECREMENT:"dial-02-decrement",CHANGE:"dial-02-change"},{INCREMENT:"dial-03-increment",DECREMENT:"dial-03-decrement",CHANGE:"dial-03-change"},{INCREMENT:"dial-04-increment",DECREMENT:"dial-04-decrement",CHANGE:"dial-04-change"}],BUTTON:[{PRESSED:"button-01-rise",RELEASED:"button-01-fall",CHANGE:"button-01-change"},{PRESSED:"button-02-rise",RELEASED:"button-02-fall",CHANGE:"button-02-change"},{PRESSED:"button-03-rise",RELEASED:"button-03-fall",CHANGE:"button-03-change"},{PRESSED:"button-04-rise",RELEASED:"button-04-fall",CHANGE:"button-04-change"},{PRESSED:"button-05-rise",RELEASED:"button-05-fall",CHANGE:"button-05-change"},{PRESSED:"button-06-rise",RELEASED:"button-06-fall",CHANGE:"button-06-change"},{PRESSED:"button-07-rise",RELEASED:"button-07-fall",CHANGE:"button-07-change"},{PRESSED:"button-08-rise",RELEASED:"button-08-fall",CHANGE:"button-08-change"},{PRESSED:"button-09-rise",RELEASED:"button-09-fall",CHANGE:"button-09-change"},{PRESSED:"button-10-rise",RELEASED:"button-10-fall",CHANGE:"button-10-change"},{PRESSED:"button-11-rise",RELEASED:"button-11-fall",CHANGE:"button-11-change"},{PRESSED:"button-12-rise",RELEASED:"button-12-fall",CHANGE:"button-12-change"},{PRESSED:"button-13-rise",RELEASED:"button-13-fall",CHANGE:"button-13-change"},{PRESSED:"button-14-rise",RELEASED:"button-14-fall",CHANGE:"button-14-change"},{PRESSED:"button-15-rise",RELEASED:"button-15-fall",CHANGE:"button-15-change"},{PRESSED:"button-16-rise",RELEASED:"button-16-fall",CHANGE:"button-16-change"}],DEVICE:{DISCONNECTED:"makeshift-disconnect",CONNECTED:"makeshift-connect",STATE_UPDATE:"state-update"},Terminal:{Log:{fatal:"makeshift-serial-log-fatal",error:"makeshift-serial-log-error",warn:"makeshift-serial-log-warn",deviceEvent:"makeshift-serial-log-event",info:"makeshift-serial-log-info",debug:"makeshift-serial-log-debug",all:"makeshift-serial-log-any"}}};const $e=function e(t){const r=[];for(const o in t){if("string"==typeof t[o])return t[o];{const n=e(t[o]);Array.isArray(n)?r.push(...n):r.push(n)}}return r}(je),Ye=je.BUTTON.length,He=je.DIAL.length,Fe={ESC:219,END:192,ESC_END:220,ESC_ESC:221},Ue={};let Ve=[];const qe=new s.EventEmitter;let Ke="info",We=!1,Qe=!0,Xe=1e3,ze=5e3,Je=1500;const Ze={},et=new J({host:"PortAuthority",logLevel:"info",showTime:!1});et.logLevel=Ke,et.showTime=We;const tt=et.getLevelLoggers();function rt(){setTimeout((()=>{nt()}),Xe),qe.emit(it.scan.started)}function ot(e){Ze[e]=setTimeout((()=>{!function(e){const t=Date.now()-Ue[e].prevAckTime;tt.debug(`elapsedTime since prevAckTime: ${t}`),t>ze?(clearTimeout(Ze[e]),tt.debug(`Timer handle - ${Ze[e]}`),tt.warn(`Device ${e}::${Ue[e].devicePath} unresponsive for ${ze}ms, disconnecting`),function(e){if(void 0===Ue[e])return;const t=Ue[e].fingerPrint;Ve=Ve.filter((e=>t.devicePath!==e.devicePath&&t.deviceSerial!==e.deviceSerial)),Ue[e].close(),delete Ue[e],qe.emit(it.port.closed,t)}(e)):(t>=Je-40&&Ue[e].ping(),ot(e))}(e)}),Je)}async function nt(){tt.debug(`scanForDevice called with autoscan set to ${Qe}`);try{const t=await e.SerialPort.list();t.forEach((e=>{tt.debug(X(e,1))}));const r=t.filter((e=>("16c0"===e.vendorId||"16C0"===e.vendorId)&&"0483"===e.productId));tt.debug(`Found MakeShift devices: ${z(r)}`),r.length>0&&r.forEach((e=>{!function(e){const t=e.path;for(const e in Ue)if(Ue[e].devicePath===t)return;const r=e.serialNumber,o={portInfo:e,id:r,logLevel:Ke,showTime:We};tt.info(`Opening device with options: '${X(o,1)}'`),Ue[r]=new Ge(o);const n=Ue[r].fingerPrint;Ve.push(n),Ue[r].ping(),ot(r),tt.deviceEvent(`Opened port: ${n.deviceSerial} | ${n.devicePath}`),qe.emit(it.port.opened,n)}(e)})),Qe?rt():qe.emit(it.scan.stopped)}catch(e){tt.error(e)}}const it={port:{opened:"makeshift-pa-port-opened",closed:"makeshift-pa-port-closed"},scan:{started:"makeshift-pa-scan-started",stopped:"makeshift-pa-scan-stopped"}};exports.DeviceEvents=je,exports.DeviceEventsFlat=$e,exports.MakeShiftPort=Ge,exports.Msg=J,exports.PortAuthority=qe,exports.PortAuthorityEvents=it,exports.Ports=Ue,exports.defaultMakeShiftPortOptions=ke,exports.getPortFingerPrintSnapShot=function(){return Ve},exports.nspct2=z,exports.nspect=X,exports.scanDelayMs=Xe,exports.scanOnce=function(){Qe=!1,nt()},exports.setLogLevel=function(e){Ke=e,et.logLevel=e;for(const t in Ue)Ue[t].logLevel=e},exports.setPortAuthorityLogLevel=function(e){et.logLevel=e},exports.setPortLogLevel=function(e,t){void 0!==Ue[e]&&(Ue[e].logLevel=t)},exports.setShowTime=function(e){We=e,et.showTime=e;for(const t in Ue)Ue[t].showTime=e},exports.startAutoScan=function(){Qe=!0,rt()},exports.stopAutoScan=function(){Qe=!1};
