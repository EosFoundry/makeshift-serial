"use strict";var e=require("serialport"),t=require("stream"),r=require("node:util"),s=require("node:process"),o=require("node:os"),n=require("node:tty"),i=require("node:events"),l=require("node:buffer"),a="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},c={},h={};Object.defineProperty(h,"__esModule",{value:!0}),h.SlipDecoder=void 0;const u=t;class d extends u.Transform{constructor(e={}){super(e);const{START:t,ESC:r=219,END:s=192,ESC_START:o,ESC_END:n=220,ESC_ESC:i=221}=e;this.opts={START:t,ESC:r,END:s,ESC_START:o,ESC_END:n,ESC_ESC:i},this.buffer=Buffer.alloc(0),this.escape=!1,this.start=!1}_transform(e,t,r){for(let t=0;t<e.length;t++){let r=e[t];if(r!==this.opts.START){if(null==this.opts.START&&(this.start=!0),this.escape)r===this.opts.ESC_START&&this.opts.START?r=this.opts.START:r===this.opts.ESC_ESC?r=this.opts.ESC:r===this.opts.ESC_END?r=this.opts.END:(this.escape=!1,this.push(this.buffer),this.buffer=Buffer.alloc(0));else{if(r===this.opts.ESC){this.escape=!0;continue}if(r===this.opts.END){this.push(this.buffer),this.buffer=Buffer.alloc(0),this.escape=!1,this.start=!1;continue}}this.escape=!1,this.start&&(this.buffer=Buffer.concat([this.buffer,Buffer.from([r])]))}else this.start=!0}r()}_flush(e){this.push(this.buffer),this.buffer=Buffer.alloc(0),e()}}h.SlipDecoder=d;var g={};Object.defineProperty(g,"__esModule",{value:!0}),g.SlipEncoder=void 0;const f=t;class p extends f.Transform{constructor(e={}){super(e);const{START:t,ESC:r=219,END:s=192,ESC_START:o,ESC_END:n=220,ESC_ESC:i=221,bluetoothQuirk:l=!1}=e;this.opts={START:t,ESC:r,END:s,ESC_START:o,ESC_END:n,ESC_ESC:i,bluetoothQuirk:l}}_transform(e,t,r){const s=e.length;if(this.opts.bluetoothQuirk&&0===s)return r();const o=Buffer.alloc(2*s+2);let n=0;1==this.opts.bluetoothQuirk&&(o[n++]=this.opts.END),void 0!==this.opts.START&&(o[n++]=this.opts.START);for(let t=0;t<s;t++){let r=e[t];r===this.opts.START&&this.opts.ESC_START?(o[n++]=this.opts.ESC,r=this.opts.ESC_START):r===this.opts.END?(o[n++]=this.opts.ESC,r=this.opts.ESC_END):r===this.opts.ESC&&(o[n++]=this.opts.ESC,r=this.opts.ESC_ESC),o[n++]=r}o[n++]=this.opts.END,r(null,o.slice(0,n))}}function E(e){return null!==e&&"object"==typeof e}function b(e,t,r=".",s){if(!E(t))return b(e,{},r,s);const o=Object.assign({},t);for(const t in e){if("__proto__"===t||"constructor"===t)continue;const n=e[t];null!=n&&(s&&s(o,t,n,r)||(Array.isArray(n)&&Array.isArray(o[t])?o[t]=[...n,...o[t]]:E(n)&&E(o[t])?o[t]=b(n,o[t],(r?`${r}.`:"")+t.toString(),s):o[t]=n))}return o}g.SlipEncoder=p,function(e){var t=a&&a.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,o)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),r=a&&a.__exportStar||function(e,r){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(r,s)||t(r,e,s)};Object.defineProperty(e,"__esModule",{value:!0}),r(h,e),r(g,e)}(c);const T=(...e)=>e.reduce(((e,t)=>b(e,t,"",undefined)),{});const m=(e=0)=>t=>`[${t+e}m`,v=(e=0)=>t=>`[${38+e};5;${t}m`,S=(e=0)=>(t,r,s)=>`[${38+e};2;${t};${r};${s}m`,R={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(R.modifier),Object.keys(R.color),Object.keys(R.bgColor);const C=function(){const e=new Map;for(const[t,r]of Object.entries(R)){for(const[t,s]of Object.entries(r))R[t]={open:`[${s[0]}m`,close:`[${s[1]}m`},r[t]=R[t],e.set(s[0],s[1]);Object.defineProperty(R,t,{value:r,enumerable:!1})}return Object.defineProperty(R,"codes",{value:e,enumerable:!1}),R.color.close="[39m",R.bgColor.close="[49m",R.color.ansi=m(),R.color.ansi256=v(),R.color.ansi16m=S(),R.bgColor.ansi=m(10),R.bgColor.ansi256=v(10),R.bgColor.ansi16m=S(10),Object.defineProperties(R,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value(e){const t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(e.toString(16));if(!t)return[0,0,0];let[r]=t;3===r.length&&(r=[...r].map((e=>e+e)).join(""));const s=Number.parseInt(r,16);return[s>>16&255,s>>8&255,255&s]},enumerable:!1},hexToAnsi256:{value:e=>R.rgbToAnsi256(...R.hexToRgb(e)),enumerable:!1},ansi256ToAnsi:{value(e){if(e<8)return 30+e;if(e<16)return e-8+90;let t,r,s;if(e>=232)t=(10*(e-232)+8)/255,r=t,s=t;else{const o=(e-=16)%36;t=Math.floor(e/36)/5,r=Math.floor(o/6)/5,s=o%6/5}const o=2*Math.max(t,r,s);if(0===o)return 30;let n=30+(Math.round(s)<<2|Math.round(r)<<1|Math.round(t));return 2===o&&(n+=60),n},enumerable:!1},rgbToAnsi:{value:(e,t,r)=>R.ansi256ToAnsi(R.rgbToAnsi256(e,t,r)),enumerable:!1},hexToAnsi:{value:e=>R.ansi256ToAnsi(R.hexToAnsi256(e)),enumerable:!1}}),R}();function A(e,t=(globalThis.Deno?globalThis.Deno.args:s.argv)){const r=e.startsWith("-")?"":1===e.length?"-":"--",o=t.indexOf(r+e),n=t.indexOf("--");return-1!==o&&(-1===n||o<n)}const{env:O}=s;let _;function y(e,{streamIsTTY:t,sniffFlags:r=!0}={}){const n=function(){if("FORCE_COLOR"in O)return"true"===O.FORCE_COLOR?1:"false"===O.FORCE_COLOR?0:0===O.FORCE_COLOR.length?1:Math.min(Number.parseInt(O.FORCE_COLOR,10),3)}();void 0!==n&&(_=n);const i=r?_:n;if(0===i)return 0;if(r){if(A("color=16m")||A("color=full")||A("color=truecolor"))return 3;if(A("color=256"))return 2}if("TF_BUILD"in O&&"AGENT_NAME"in O)return 1;if(e&&!t&&void 0===i)return 0;const l=i||0;if("dumb"===O.TERM)return l;if("win32"===s.platform){const e=o.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in O)return"GITHUB_ACTIONS"in O?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some((e=>e in O))||"codeship"===O.CI_NAME?1:l;if("TEAMCITY_VERSION"in O)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(O.TEAMCITY_VERSION)?1:0;if("truecolor"===O.COLORTERM)return 3;if("xterm-kitty"===O.TERM)return 3;if("TERM_PROGRAM"in O){const e=Number.parseInt((O.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(O.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(O.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(O.TERM)||"COLORTERM"in O?1:l}function D(e,t={}){return function(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}(y(e,{streamIsTTY:e&&e.isTTY,...t}))}A("no-color")||A("no-colors")||A("color=false")||A("color=never")?_=0:(A("color")||A("colors")||A("color=true")||A("color=always"))&&(_=1);const N={stdout:D({isTTY:n.isatty(1)}),stderr:D({isTTY:n.isatty(2)})};function P(e,t,r){let s=e.indexOf(t);if(-1===s)return e;const o=t.length;let n=0,i="";do{i+=e.slice(n,s)+t+r,n=s+o,s=e.indexOf(t,n)}while(-1!==s);return i+=e.slice(n),i}const{stdout:I,stderr:w}=N,M=Symbol("GENERATOR"),L=Symbol("STYLER"),B=Symbol("IS_EMPTY"),k=["ansi","ansi","ansi256","ansi16m"],x=Object.create(null);function G(e){return(e=>{const t=(...e)=>e.join(" ");return((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const r=I?I.level:0;e.level=void 0===t.level?r:t.level})(t,e),Object.setPrototypeOf(t,G.prototype),t})(e)}Object.setPrototypeOf(G.prototype,Function.prototype);for(const[e,t]of Object.entries(C))x[e]={get(){const r=F(this,H(t.open,t.close,this[L]),this[B]);return Object.defineProperty(this,e,{value:r}),r}};x.visible={get(){const e=F(this,this[L],!0);return Object.defineProperty(this,"visible",{value:e}),e}};const j=(e,t,r,...s)=>"rgb"===e?"ansi16m"===t?C[r].ansi16m(...s):"ansi256"===t?C[r].ansi256(C.rgbToAnsi256(...s)):C[r].ansi(C.rgbToAnsi(...s)):"hex"===e?j("rgb",t,r,...C.hexToRgb(...s)):C[r][e](...s),$=["rgb","hex","ansi256"];for(const e of $)x[e]={get(){const{level:t}=this;return function(...r){const s=H(j(e,k[t],"color",...r),C.color.close,this[L]);return F(this,s,this[B])}}},x["bg"+e[0].toUpperCase()+e.slice(1)]={get(){const{level:t}=this;return function(...r){const s=H(j(e,k[t],"bgColor",...r),C.bgColor.close,this[L]);return F(this,s,this[B])}}};const Y=Object.defineProperties((()=>{}),{...x,level:{enumerable:!0,get(){return this[M].level},set(e){this[M].level=e}}}),H=(e,t,r)=>{let s,o;return void 0===r?(s=e,o=t):(s=r.openAll+e,o=t+r.closeAll),{open:e,close:t,openAll:s,closeAll:o,parent:r}},F=(e,t,r)=>{const s=(...e)=>U(s,1===e.length?""+e[0]:e.join(" "));return Object.setPrototypeOf(s,Y),s[M]=e,s[L]=t,s[B]=r,s},U=(e,t)=>{if(e.level<=0||!t)return e[B]?"":t;let r=e[L];if(void 0===r)return t;const{openAll:s,closeAll:o}=r;if(t.includes(""))for(;void 0!==r;)t=P(t,r.close,r.open),r=r.parent;const n=t.indexOf("\n");return-1!==n&&(t=function(e,t,r,s){let o=0,n="";do{const i="\r"===e[s-1];n+=e.slice(o,i?s-1:s)+t+(i?"\r\n":"\n")+r,o=s+1,s=e.indexOf("\n",o)}while(-1!==s);return n+=e.slice(o),n}(t,o,s,n)),s+t+o};Object.defineProperties(G.prototype,x);const V=G();G({level:w?w.level:0});const q={all:0,debug:1,deviceEvent:2,info:3,warn:4,error:5,fatal:98,none:99},K={host:"",logLevel:"all",prompt:" => ",showTime:!1,symbol:{debug:"dbg",info:"",deviceEvent:"",warn:"(!)",error:"[!]",fatal:"{x_X}"},terminal:!0},W={debug:V.gray,info:V.white,deviceEvent:V.green,warn:V.yellow,error:V.red,fatal:V.redBright};function Q(e,t){return r.inspect(e,{colors:!0,depth:t})}function z(e){return r.inspect(e,{colors:!0,depth:2})}class X{_debug=()=>{};_info=()=>{};_deviceEvent=()=>{};_warn=()=>{};_error=()=>{};_fatal=()=>{};_defaultLogger(e,t){console.log(e)}prompt=" => ";host="";logLevel="all";terminal=!0;showTime=!1;showMillis=!1;get time(){const e=new Date;let t="",r="",s="";e.getHours()<10&&(t="0"),e.getMinutes()<10&&(r="0"),e.getSeconds()<10&&(s="0"),t+=e.getHours(),r+=e.getMinutes(),s+=e.getSeconds();let o=t+":"+r+":"+s;return this.showMillis&&(o+=":"+e.getMilliseconds()),V.grey(o)}ps(e){let t="";return!0===this.showTime&&(t+=this.time+" "),""!==this.symbol[e]&&(t+=W[e](this.symbol[e])+" "),t+=W[e](this.host)+this.prompt,t}symbol;assignOptions(e,t){for(const r in t)"object"!=typeof e[r]?e[r]=t[r]||e[r]:this.assignOptions(e[r],t[r])}getLevelLoggers(){return{debug:this._debug,info:this._info,deviceEvent:this._deviceEvent,warn:this._warn,error:this._error,fatal:this._fatal}}logger=this._defaultLogger;resetLogger(){this.logger=this._defaultLogger}constructor(e=K){const t=T(e,K);this.assignOptions(this,t),this.spawnLevelLoggers()}spawnLevelLoggers(){for(let e in this.symbol){let t=e;this["_"+e]=e=>{let r=`${this.ps(t)}${s=e,"string"==typeof s?s:z(s)}`;var s;return q[this.logLevel]<=q[t]&&this.logger(r,t),r}}}}const J=/(^|[/\\])([^/\\]+?)(?=(\.[^.]+)?$)/;const Z=(e=0)=>t=>`[${t+e}m`,ee=(e=0)=>t=>`[${38+e};5;${t}m`,te=(e=0)=>(t,r,s)=>`[${38+e};2;${t};${r};${s}m`,re={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(re.modifier);Object.keys(re.color),Object.keys(re.bgColor);const se=function(){const e=new Map;for(const[t,r]of Object.entries(re)){for(const[t,s]of Object.entries(r))re[t]={open:`[${s[0]}m`,close:`[${s[1]}m`},r[t]=re[t],e.set(s[0],s[1]);Object.defineProperty(re,t,{value:r,enumerable:!1})}return Object.defineProperty(re,"codes",{value:e,enumerable:!1}),re.color.close="[39m",re.bgColor.close="[49m",re.color.ansi=Z(),re.color.ansi256=ee(),re.color.ansi16m=te(),re.bgColor.ansi=Z(10),re.bgColor.ansi256=ee(10),re.bgColor.ansi16m=te(10),Object.defineProperties(re,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value(e){const t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(e.toString(16));if(!t)return[0,0,0];let[r]=t;3===r.length&&(r=[...r].map((e=>e+e)).join(""));const s=Number.parseInt(r,16);return[s>>16&255,s>>8&255,255&s]},enumerable:!1},hexToAnsi256:{value:e=>re.rgbToAnsi256(...re.hexToRgb(e)),enumerable:!1},ansi256ToAnsi:{value(e){if(e<8)return 30+e;if(e<16)return e-8+90;let t,r,s;if(e>=232)t=(10*(e-232)+8)/255,r=t,s=t;else{const o=(e-=16)%36;t=Math.floor(e/36)/5,r=Math.floor(o/6)/5,s=o%6/5}const o=2*Math.max(t,r,s);if(0===o)return 30;let n=30+(Math.round(s)<<2|Math.round(r)<<1|Math.round(t));return 2===o&&(n+=60),n},enumerable:!1},rgbToAnsi:{value:(e,t,r)=>re.ansi256ToAnsi(re.rgbToAnsi256(e,t,r)),enumerable:!1},hexToAnsi:{value:e=>re.ansi256ToAnsi(re.hexToAnsi256(e)),enumerable:!1}}),re}();function oe(e,t=(globalThis.Deno?globalThis.Deno.args:s.argv)){const r=e.startsWith("-")?"":1===e.length?"-":"--",o=t.indexOf(r+e),n=t.indexOf("--");return-1!==o&&(-1===n||o<n)}const{env:ne}=s;let ie;function le(e,{streamIsTTY:t,sniffFlags:r=!0}={}){const n=function(){if("FORCE_COLOR"in ne)return"true"===ne.FORCE_COLOR?1:"false"===ne.FORCE_COLOR?0:0===ne.FORCE_COLOR.length?1:Math.min(Number.parseInt(ne.FORCE_COLOR,10),3)}();void 0!==n&&(ie=n);const i=r?ie:n;if(0===i)return 0;if(r){if(oe("color=16m")||oe("color=full")||oe("color=truecolor"))return 3;if(oe("color=256"))return 2}if("TF_BUILD"in ne&&"AGENT_NAME"in ne)return 1;if(e&&!t&&void 0===i)return 0;const l=i||0;if("dumb"===ne.TERM)return l;if("win32"===s.platform){const e=o.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in ne)return"GITHUB_ACTIONS"in ne?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some((e=>e in ne))||"codeship"===ne.CI_NAME?1:l;if("TEAMCITY_VERSION"in ne)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(ne.TEAMCITY_VERSION)?1:0;if("truecolor"===ne.COLORTERM)return 3;if("xterm-kitty"===ne.TERM)return 3;if("TERM_PROGRAM"in ne){const e=Number.parseInt((ne.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(ne.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(ne.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(ne.TERM)||"COLORTERM"in ne?1:l}function ae(e,t={}){return function(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}(le(e,{streamIsTTY:e&&e.isTTY,...t}))}oe("no-color")||oe("no-colors")||oe("color=false")||oe("color=never")?ie=0:(oe("color")||oe("colors")||oe("color=true")||oe("color=always"))&&(ie=1);const ce={stdout:ae({isTTY:n.isatty(1)}),stderr:ae({isTTY:n.isatty(2)})};function he(e,t,r){let s=e.indexOf(t);if(-1===s)return e;const o=t.length;let n=0,i="";do{i+=e.slice(n,s)+t+r,n=s+o,s=e.indexOf(t,n)}while(-1!==s);return i+=e.slice(n),i}const{stdout:ue,stderr:de}=ce,ge=Symbol("GENERATOR"),fe=Symbol("STYLER"),pe=Symbol("IS_EMPTY"),Ee=["ansi","ansi","ansi256","ansi16m"],be=Object.create(null),Te=e=>{const t=(...e)=>e.join(" ");return((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const r=ue?ue.level:0;e.level=void 0===t.level?r:t.level})(t,e),Object.setPrototypeOf(t,me.prototype),t};function me(e){return Te(e)}Object.setPrototypeOf(me.prototype,Function.prototype);for(const[e,t]of Object.entries(se))be[e]={get(){const r=Ae(this,Ce(t.open,t.close,this[fe]),this[pe]);return Object.defineProperty(this,e,{value:r}),r}};be.visible={get(){const e=Ae(this,this[fe],!0);return Object.defineProperty(this,"visible",{value:e}),e}};const ve=(e,t,r,...s)=>"rgb"===e?"ansi16m"===t?se[r].ansi16m(...s):"ansi256"===t?se[r].ansi256(se.rgbToAnsi256(...s)):se[r].ansi(se.rgbToAnsi(...s)):"hex"===e?ve("rgb",t,r,...se.hexToRgb(...s)):se[r][e](...s),Se=["rgb","hex","ansi256"];for(const e of Se){be[e]={get(){const{level:t}=this;return function(...r){const s=Ce(ve(e,Ee[t],"color",...r),se.color.close,this[fe]);return Ae(this,s,this[pe])}}};be["bg"+e[0].toUpperCase()+e.slice(1)]={get(){const{level:t}=this;return function(...r){const s=Ce(ve(e,Ee[t],"bgColor",...r),se.bgColor.close,this[fe]);return Ae(this,s,this[pe])}}}}const Re=Object.defineProperties((()=>{}),{...be,level:{enumerable:!0,get(){return this[ge].level},set(e){this[ge].level=e}}}),Ce=(e,t,r)=>{let s,o;return void 0===r?(s=e,o=t):(s=r.openAll+e,o=t+r.closeAll),{open:e,close:t,openAll:s,closeAll:o,parent:r}},Ae=(e,t,r)=>{const s=(...e)=>Oe(s,1===e.length?""+e[0]:e.join(" "));return Object.setPrototypeOf(s,Re),s[ge]=e,s[fe]=t,s[pe]=r,s},Oe=(e,t)=>{if(e.level<=0||!t)return e[pe]?"":t;let r=e[fe];if(void 0===r)return t;const{openAll:s,closeAll:o}=r;if(t.includes(""))for(;void 0!==r;)t=he(t,r.close,r.open),r=r.parent;const n=t.indexOf("\n");return-1!==n&&(t=function(e,t,r,s){let o=0,n="";do{const i="\r"===e[s-1];n+=e.slice(o,i?s-1:s)+t+(i?"\r\n":"\n")+r,o=s+1,s=e.indexOf("\n",o)}while(-1!==s);return n+=e.slice(o),n}(t,o,s,n)),s+t+o};Object.defineProperties(me.prototype,be);const _e=me();function ye(e){return null!==e&&"object"==typeof e}function De(e,t,r=".",s){if(!ye(t))return De(e,{},r,s);const o=Object.assign({},t);for(const t in e){if("__proto__"===t||"constructor"===t)continue;const n=e[t];null!=n&&(s&&s(o,t,n,r)||(Array.isArray(n)&&Array.isArray(o[t])?o[t]=[...n,...o[t]]:ye(n)&&ye(o[t])?o[t]=De(n,o[t],(r?`${r}.`:"")+t.toString(),s):o[t]=n))}return o}me({level:de?de.level:0});const Ne=(...e)=>e.reduce(((e,t)=>De(e,t,"",Pe)),{});var Pe,Ie=[{INCREMENT:"sensor-0-dial-increment",DECREMENT:"sensor-0-dial-decrement",CHANGED:"sensor-0-dial-changed"},{INCREMENT:"sensor-1-dial-increment",DECREMENT:"sensor-1-dial-decrement",CHANGED:"sensor-1-dial-changed"},{INCREMENT:"sensor-2-dial-increment",DECREMENT:"sensor-2-dial-decrement",CHANGED:"sensor-2-dial-changed"},{INCREMENT:"sensor-3-dial-increment",DECREMENT:"sensor-3-dial-decrement",CHANGED:"sensor-3-dial-changed"}],we=[{PRESSED:"sensor-0-button-pressed",RELEASED:"sensor-0-button-released",CHANGED:"sensor-0-button-changed"},{PRESSED:"sensor-1-button-pressed",RELEASED:"sensor-1-button-released",CHANGED:"sensor-1-button-changed"},{PRESSED:"sensor-2-button-pressed",RELEASED:"sensor-2-button-released",CHANGED:"sensor-2-button-changed"},{PRESSED:"sensor-3-button-pressed",RELEASED:"sensor-3-button-released",CHANGED:"sensor-3-button-changed"},{PRESSED:"sensor-4-button-pressed",RELEASED:"sensor-4-button-released",CHANGED:"sensor-4-button-changed"},{PRESSED:"sensor-5-button-pressed",RELEASED:"sensor-5-button-released",CHANGED:"sensor-5-button-changed"},{PRESSED:"sensor-6-button-pressed",RELEASED:"sensor-6-button-released",CHANGED:"sensor-6-button-changed"},{PRESSED:"sensor-7-button-pressed",RELEASED:"sensor-7-button-released",CHANGED:"sensor-7-button-changed"},{PRESSED:"sensor-8-button-pressed",RELEASED:"sensor-8-button-released",CHANGED:"sensor-8-button-changed"},{PRESSED:"sensor-9-button-pressed",RELEASED:"sensor-9-button-released",CHANGED:"sensor-9-button-changed"},{PRESSED:"sensor-10-button-pressed",RELEASED:"sensor-10-button-released",CHANGED:"sensor-10-button-changed"},{PRESSED:"sensor-11-button-pressed",RELEASED:"sensor-11-button-released",CHANGED:"sensor-11-button-changed"},{PRESSED:"sensor-12-button-pressed",RELEASED:"sensor-12-button-released",CHANGED:"sensor-12-button-changed"},{PRESSED:"sensor-13-button-pressed",RELEASED:"sensor-13-button-released",CHANGED:"sensor-13-button-changed"},{PRESSED:"sensor-14-button-pressed",RELEASED:"sensor-14-button-released",CHANGED:"sensor-14-button-changed"},{PRESSED:"sensor-15-button-pressed",RELEASED:"sensor-15-button-released",CHANGED:"sensor-15-button-changed"}],Me={DIAL:Ie,BUTTON:we};const Le={Log:{fatal:"makeshift-serial-log-fatal",error:"makeshift-serial-log-error",warn:"makeshift-serial-log-warn",deviceEvent:"makeshift-serial-log-event",info:"makeshift-serial-log-info",debug:"makeshift-serial-log-debug",all:"makeshift-serial-log-any"}},Be={...Object.freeze({__proto__:null,BUTTON:we,DIAL:Ie,default:Me}),DEVICE:{CONNECTION_ERROR:"makeshift-connection-error",DISCONNECTED:"makeshift-disconnect",CONNECTED:"makeshift-connect",STATE_UPDATE:"state-update"}};let ke=0;var xe;exports.PacketType=void 0,(xe=exports.PacketType||(exports.PacketType={}))[xe.PING=0]="PING",xe[xe.ACK=1]="ACK",xe[xe.READY=2]="READY",xe[xe.STATE_UPDATE=3]="STATE_UPDATE",xe[xe.ERROR=4]="ERROR",xe[xe.STRING=5]="STRING",xe[xe.DISCONNECT=6]="DISCONNECT";const Ge={portInfo:{},logLevel:"all",id:"",showTime:!1};class je extends i.EventEmitter{serialPort;slipEncoder=new c.SlipEncoder(He);slipDecoder=new c.SlipDecoder(He);_prevAckTime=0;prevState={buttons:[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],dials:[0,0,0,0],dialsRelative:[0,0,0,0]};_deviceReady=!1;_id="";_portInfo=null;_msger;keepAliveTimer;static get connectedDevices(){return ke}get prevAckTime(){return this._prevAckTime}get isOpen(){return void 0!==this.serialPort&&this.serialPort.isOpen}get devicePath(){return null!==this._portInfo?this._portInfo.path:""}get deviceSerial(){return this._id}get fingerPrint(){return{devicePath:this.devicePath,deviceSerial:this.deviceSerial,portId:this.portId}}get portInfo(){return this._portInfo}get portId(){return null!==this._portInfo?this._portInfo.serialNumber:""}log;debug;deviceEvent;info;warn;error;fatal;get host(){let e="Port:"+_e.green((t=this.devicePath,t.match(J)?.[2]))+"|";var t;return this._deviceReady?e+=_e.magenta(this.deviceSerial.slice(0,4)):e+=_e.yellow("D/C"),e}_logLevel="all";get showTime(){return this._msger.showTime}set showTime(e){this._msger.showTime=e}get logLevel(){return this._logLevel}set logLevel(e){this._logLevel=e,this._msger.logLevel=e}get logTermFormat(){return this._msger.terminal}set logTermFormat(e){this._msger.terminal=e}emitLog=(e,t)=>{this.emit(Le.Log[t],{level:t,message:e,buffer:l.Buffer.from(e)})};constructor(e){super();const t=Ne(e,Ge);this._portInfo=t.portInfo,this._msger=new X,this._msger.host=this.host,this._msger.showTime=t.showTime,this.log=this._msger.getLevelLoggers(),this.logLevel=t.logLevel;for(const e in this.log)this[e]=t=>{const r=this.log[e](t);this.emitLog(r,e)};this.debug("Creating new MakeShiftPort with options: "+z(t)),this.slipDecoder.on("data",(e=>{this.parseSlipPacketHeader(e)})),this.open()}parseSlipPacketHeader(e){this._prevAckTime=Date.now();const t=e.subarray(0,1).at(0),r=e.subarray(1);switch(this.debug(e),t){case exports.PacketType.STATE_UPDATE:{let e=je.parseStateFromBuffer(r);this.emit(Be.DEVICE.STATE_UPDATE,e),this.debug("state updating"),this.handleStateUpdate(e);break}case exports.PacketType.ACK:this.debug("Got ACK from MakeShift");break;case exports.PacketType.STRING:this.debug(r.toString());break;case exports.PacketType.PING:this.debug("Got PING from MakeShift, responding with ACK"),this.sendByte(exports.PacketType.ACK);break;case exports.PacketType.ERROR:this.debug("Got ERROR from MakeShift");break;case exports.PacketType.READY:this.debug("Got READY from MakeShift"),this.debug(r.toString()),ke++,this._deviceReady=!0,this._id=r.toString().replaceAll("-",""),this._msger.host=this.host,this._prevAckTime=Date.now(),this.deviceEvent("Device connection established"),this.emit(Be.DEVICE.CONNECTED,this.fingerPrint);break;default:this.debug(t),this.debug(e.toString())}}ping(){this.sendByte(exports.PacketType.PING)}handleStateUpdate(e){this.debug("Handling state update");for(let t=0;t<$e;t++)if(e.buttons[t]!=this.prevState.buttons[t]){let r;r=!0===e.buttons[t]?Be.BUTTON[t].PRESSED:Be.BUTTON[t].RELEASED,this.emit(r,{state:e,event:r}),this.deviceEvent(`${r} with state ${e.buttons[t]}`)}for(let t=0;t<Ye;t++)if(e.dials[t],this.prevState.dials[t],0!==e.dialsRelative[t]){let r;this.emit(Be.DIAL[t].CHANGED,{state:e,event:r}),r=e.dialsRelative[t]>0?Be.DIAL[t].INCREMENT:Be.DIAL[t].DECREMENT,this.emit(r,{state:e,event:r}),this.deviceEvent(`${r} with state ${e.dials[t]}`)}this.prevState=e}sendByte(e){if(this.isOpen)try{this.serialPort.flush();let t=l.Buffer.from([e]);this.debug(`Sending byte: ${z(t)}`),this.slipEncoder.write(t)}catch(e){this.error(e)}}send(e,t){if(this.isOpen)try{this.serialPort.flush();let r=l.Buffer.from([e]),s=l.Buffer.from(t);const o=l.Buffer.concat([r,s]);this.debug(`Sending buffer: ${z(o)}`),this.slipEncoder.write(o)}catch(e){this.error(e)}}static parseStateFromBuffer(e){let t={buttons:[],dials:[],dialsRelative:[]};const r=e.subarray(0,2).reverse(),s=e.subarray(2,6),o=e.subarray(6);function n(e,r){0!==r&&(e%2?t.buttons.push(!0):t.buttons.push(!1),n(Math.floor(e/2),r-1))}r.forEach((e=>n(e,8)));for(let e=0;e<4;e++)t.dialsRelative.push(s.readInt8(e));return t.dials.push(o.readInt32BE(0)),t.dials.push(o.readInt32BE(4)),t.dials.push(o.readInt32BE(8)),t.dials.push(o.readInt32BE(12)),t}async open(){this.serialPort=await new e.SerialPort({path:this.devicePath,baudRate:42069},(e=>{null!=e?(this.error("Something happened while opening port: "),this.error(e),this.emit(Be.DEVICE.CONNECTION_ERROR,e)):(this._msger.host=this.host,this.info("SerialPort opened, attaching SLIP translators"),this.slipEncoder.pipe(this.serialPort),this.serialPort.pipe(this.slipDecoder),this.info("Translators ready, sending READY to MakeShift"),this.sendByte(exports.PacketType.READY))}))}close(){this.info("Closing MakeShift port..."),this.info("Unpiping encoders"),this.slipEncoder.unpipe(),this.serialPort.unpipe(),this.isOpen&&(this.info("Port object found open"),this.info("Sending disconnect packet"),this.sendByte(exports.PacketType.DISCONNECT),this.info("Closing port"),this.serialPort.close()),this._msger.host=this.host,ke--,this._deviceReady=!1,this.warn("Port closed, sending disconnect signal"),this.emit(Be.DEVICE.DISCONNECTED,this.fingerPrint)}write=e=>{this._deviceReady?this.send(exports.PacketType.STRING,e):this.info("MakeShift not ready, line not sent")}}const $e=Be.BUTTON.length,Ye=Be.DIAL.length,He={ESC:219,END:192,ESC_END:220,ESC_ESC:221},Fe={};let Ue=[];const Ve=new i.EventEmitter;let qe="info",Ke=!1,We=!0,Qe=1e3,ze=5e3,Xe=1500;const Je={},Ze=new X({host:"PortAuthority",logLevel:"info",showTime:!1});Ze.logLevel=qe,Ze.showTime=Ke;const et=Ze.getLevelLoggers();function tt(){setTimeout((()=>{st()}),Qe),Ve.emit(ot.scan.started)}function rt(e){Je[e]=setTimeout((()=>{!function(e){const t=Date.now()-Fe[e].prevAckTime;et.debug(`elapsedTime since prevAckTime: ${t}`),t>ze?(clearTimeout(Je[e]),et.debug(`Timer handle - ${Je[e]}`),et.warn(`Device ${e}::${Fe[e].devicePath} unresponsive for ${ze}ms, disconnecting`),function(e){if(void 0===Fe[e])return;const t=Fe[e].fingerPrint;Ue=Ue.filter((e=>t.devicePath!==e.devicePath&&t.deviceSerial!==e.deviceSerial)),Fe[e].close(),delete Fe[e],Ve.emit(ot.port.closed,t)}(e)):(t>=Xe-40&&Fe[e].ping(),rt(e))}(e)}),Xe)}async function st(){et.debug(`scanForDevice called with autoscan set to ${We}`);try{const t=await e.SerialPort.list();t.forEach((e=>{et.debug(Q(e,1))}));const r=t.filter((e=>("16c0"===e.vendorId||"16C0"===e.vendorId)&&"0483"===e.productId));et.debug(`Found MakeShift devices: ${z(r)}`),r.length>0&&r.forEach((e=>{!function(e){const t=e.path;for(const e in Fe)if(Fe[e].devicePath===t)return;const r={portInfo:e,logLevel:qe,showTime:Ke};et.info(`Opening device with options: '${Q(r,1)}'`);let s=new je(r);s.once(Be.DEVICE.CONNECTED,(e=>{const t=e.deviceSerial;Fe[t]=s,Ue.push(e),Fe[t].ping(),rt(t),et.deviceEvent(`Opened port ${e.devicePath}, with deviceSerial ${_e.magenta(e.deviceSerial)}`),Ve.emit(ot.port.opened,e)})),s.once(Be.DEVICE.CONNECTION_ERROR,(e=>{et.error(`Error opening device on port ${t}: ${e.message}`)}))}(e)})),We?tt():Ve.emit(ot.scan.stopped)}catch(e){et.error(e)}}const ot={port:{opened:"makeshift-pa-port-opened",closed:"makeshift-pa-port-closed"},scan:{started:"makeshift-pa-scan-started",stopped:"makeshift-pa-scan-stopped"}};exports.DeviceEvents=Be,exports.MakeShiftPort=je,exports.PortAuthority=Ve,exports.PortAuthorityEvents=ot,exports.Ports=Fe,exports.SerialEvents=Le,exports.defaultMakeShiftPortOptions=Ge,exports.getPortFingerPrintSnapShot=function(){return Ue},exports.scanDelayMs=Qe,exports.scanOnce=function(){We=!1,st()},exports.setLogLevel=function(e){qe=e,Ze.logLevel=e;for(const t in Fe)Fe[t].logLevel=e},exports.setPortAuthorityLogLevel=function(e){Ze.logLevel=e},exports.setPortLogLevel=function(e,t){void 0!==Fe[e]&&(Fe[e].logLevel=t)},exports.setShowTime=function(e){Ke=e,Ze.showTime=e;for(const t in Fe)Fe[t].showTime=e},exports.startAutoScan=function(){We=!0,tt()},exports.stopAutoScan=function(){We=!1};
