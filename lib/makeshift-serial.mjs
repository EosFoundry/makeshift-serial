import{SerialPort as e}from"serialport";import t from"stream";import{inspect as o}from"node:util";import r from"node:process";import i from"node:os";import n from"node:tty";import{EventEmitter as s}from"node:events";import{Buffer as l}from"node:buffer";var a="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},c={},h={};Object.defineProperty(h,"__esModule",{value:!0}),h.SlipDecoder=void 0;const u=t;class f extends u.Transform{constructor(e={}){super(e);const{START:t,ESC:o=219,END:r=192,ESC_START:i,ESC_END:n=220,ESC_ESC:s=221}=e;this.opts={START:t,ESC:o,END:r,ESC_START:i,ESC_END:n,ESC_ESC:s},this.buffer=Buffer.alloc(0),this.escape=!1,this.start=!1}_transform(e,t,o){for(let t=0;t<e.length;t++){let o=e[t];if(o!==this.opts.START){if(null==this.opts.START&&(this.start=!0),this.escape)o===this.opts.ESC_START&&this.opts.START?o=this.opts.START:o===this.opts.ESC_ESC?o=this.opts.ESC:o===this.opts.ESC_END?o=this.opts.END:(this.escape=!1,this.push(this.buffer),this.buffer=Buffer.alloc(0));else{if(o===this.opts.ESC){this.escape=!0;continue}if(o===this.opts.END){this.push(this.buffer),this.buffer=Buffer.alloc(0),this.escape=!1,this.start=!1;continue}}this.escape=!1,this.start&&(this.buffer=Buffer.concat([this.buffer,Buffer.from([o])]))}else this.start=!0}o()}_flush(e){this.push(this.buffer),this.buffer=Buffer.alloc(0),e()}}h.SlipDecoder=f;var g={};Object.defineProperty(g,"__esModule",{value:!0}),g.SlipEncoder=void 0;const d=t;class E extends d.Transform{constructor(e={}){super(e);const{START:t,ESC:o=219,END:r=192,ESC_START:i,ESC_END:n=220,ESC_ESC:s=221,bluetoothQuirk:l=!1}=e;this.opts={START:t,ESC:o,END:r,ESC_START:i,ESC_END:n,ESC_ESC:s,bluetoothQuirk:l}}_transform(e,t,o){const r=e.length;if(this.opts.bluetoothQuirk&&0===r)return o();const i=Buffer.alloc(2*r+2);let n=0;1==this.opts.bluetoothQuirk&&(i[n++]=this.opts.END),void 0!==this.opts.START&&(i[n++]=this.opts.START);for(let t=0;t<r;t++){let o=e[t];o===this.opts.START&&this.opts.ESC_START?(i[n++]=this.opts.ESC,o=this.opts.ESC_START):o===this.opts.END?(i[n++]=this.opts.ESC,o=this.opts.ESC_END):o===this.opts.ESC&&(i[n++]=this.opts.ESC,o=this.opts.ESC_ESC),i[n++]=o}i[n++]=this.opts.END,o(null,i.slice(0,n))}}var b,p,m;function T(e){return null!==e&&"object"==typeof e}function v(e,t,o=".",r){if(!T(t))return v(e,{},o,r);const i=Object.assign({},t);for(const t in e){if("__proto__"===t||"constructor"===t)continue;const n=e[t];null!=n&&(r&&r(i,t,n,o)||(Array.isArray(n)&&Array.isArray(i[t])?i[t]=[...n,...i[t]]:T(n)&&T(i[t])?i[t]=v(n,i[t],(o?`${o}.`:"")+t.toString(),r):i[t]=n))}return i}g.SlipEncoder=E,b=c,p=a&&a.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,i)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),m=a&&a.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||p(t,e,o)},Object.defineProperty(b,"__esModule",{value:!0}),m(h,b),m(g,b);const S=(...e)=>e.reduce(((e,t)=>v(e,t,"",undefined)),{});const R=(e=0)=>t=>`[${t+e}m`,C=(e=0)=>t=>`[${38+e};5;${t}m`,A=(e=0)=>(t,o,r)=>`[${38+e};2;${t};${o};${r}m`,O={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(O.modifier),Object.keys(O.color),Object.keys(O.bgColor);const _=function(){const e=new Map;for(const[t,o]of Object.entries(O)){for(const[t,r]of Object.entries(o))O[t]={open:`[${r[0]}m`,close:`[${r[1]}m`},o[t]=O[t],e.set(r[0],r[1]);Object.defineProperty(O,t,{value:o,enumerable:!1})}return Object.defineProperty(O,"codes",{value:e,enumerable:!1}),O.color.close="[39m",O.bgColor.close="[49m",O.color.ansi=R(),O.color.ansi256=C(),O.color.ansi16m=A(),O.bgColor.ansi=R(10),O.bgColor.ansi256=C(10),O.bgColor.ansi16m=A(10),Object.defineProperties(O,{rgbToAnsi256:{value:(e,t,o)=>e===t&&t===o?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(o/255*5),enumerable:!1},hexToRgb:{value(e){const t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(e.toString(16));if(!t)return[0,0,0];let[o]=t;3===o.length&&(o=[...o].map((e=>e+e)).join(""));const r=Number.parseInt(o,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>O.rgbToAnsi256(...O.hexToRgb(e)),enumerable:!1},ansi256ToAnsi:{value(e){if(e<8)return 30+e;if(e<16)return e-8+90;let t,o,r;if(e>=232)t=(10*(e-232)+8)/255,o=t,r=t;else{const i=(e-=16)%36;t=Math.floor(e/36)/5,o=Math.floor(i/6)/5,r=i%6/5}const i=2*Math.max(t,o,r);if(0===i)return 30;let n=30+(Math.round(r)<<2|Math.round(o)<<1|Math.round(t));return 2===i&&(n+=60),n},enumerable:!1},rgbToAnsi:{value:(e,t,o)=>O.ansi256ToAnsi(O.rgbToAnsi256(e,t,o)),enumerable:!1},hexToAnsi:{value:e=>O.ansi256ToAnsi(O.hexToAnsi256(e)),enumerable:!1}}),O}();function y(e,t=(globalThis.Deno?globalThis.Deno.args:r.argv)){const o=e.startsWith("-")?"":1===e.length?"-":"--",i=t.indexOf(o+e),n=t.indexOf("--");return-1!==i&&(-1===n||i<n)}const{env:N}=r;let D;function I(e,{streamIsTTY:t,sniffFlags:o=!0}={}){const n=function(){if("FORCE_COLOR"in N)return"true"===N.FORCE_COLOR?1:"false"===N.FORCE_COLOR?0:0===N.FORCE_COLOR.length?1:Math.min(Number.parseInt(N.FORCE_COLOR,10),3)}();void 0!==n&&(D=n);const s=o?D:n;if(0===s)return 0;if(o){if(y("color=16m")||y("color=full")||y("color=truecolor"))return 3;if(y("color=256"))return 2}if("TF_BUILD"in N&&"AGENT_NAME"in N)return 1;if(e&&!t&&void 0===s)return 0;const l=s||0;if("dumb"===N.TERM)return l;if("win32"===r.platform){const e=i.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in N)return"GITHUB_ACTIONS"in N?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some((e=>e in N))||"codeship"===N.CI_NAME?1:l;if("TEAMCITY_VERSION"in N)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(N.TEAMCITY_VERSION)?1:0;if("truecolor"===N.COLORTERM)return 3;if("xterm-kitty"===N.TERM)return 3;if("TERM_PROGRAM"in N){const e=Number.parseInt((N.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(N.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(N.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(N.TERM)||"COLORTERM"in N?1:l}function P(e,t={}){return function(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}(I(e,{streamIsTTY:e&&e.isTTY,...t}))}y("no-color")||y("no-colors")||y("color=false")||y("color=never")?D=0:(y("color")||y("colors")||y("color=true")||y("color=always"))&&(D=1);const w={stdout:P({isTTY:n.isatty(1)}),stderr:P({isTTY:n.isatty(2)})};function M(e,t,o){let r=e.indexOf(t);if(-1===r)return e;const i=t.length;let n=0,s="";do{s+=e.slice(n,r)+t+o,n=r+i,r=e.indexOf(t,n)}while(-1!==r);return s+=e.slice(n),s}const{stdout:L,stderr:B}=w,k=Symbol("GENERATOR"),G=Symbol("STYLER"),j=Symbol("IS_EMPTY"),x=["ansi","ansi","ansi256","ansi16m"],$=Object.create(null);function Y(e){return(e=>{const t=(...e)=>e.join(" ");return((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const o=L?L.level:0;e.level=void 0===t.level?o:t.level})(t,e),Object.setPrototypeOf(t,Y.prototype),t})(e)}Object.setPrototypeOf(Y.prototype,Function.prototype);for(const[e,t]of Object.entries(_))$[e]={get(){const o=K(this,V(t.open,t.close,this[G]),this[j]);return Object.defineProperty(this,e,{value:o}),o}};$.visible={get(){const e=K(this,this[G],!0);return Object.defineProperty(this,"visible",{value:e}),e}};const H=(e,t,o,...r)=>"rgb"===e?"ansi16m"===t?_[o].ansi16m(...r):"ansi256"===t?_[o].ansi256(_.rgbToAnsi256(...r)):_[o].ansi(_.rgbToAnsi(...r)):"hex"===e?H("rgb",t,o,..._.hexToRgb(...r)):_[o][e](...r),F=["rgb","hex","ansi256"];for(const e of F)$[e]={get(){const{level:t}=this;return function(...o){const r=V(H(e,x[t],"color",...o),_.color.close,this[G]);return K(this,r,this[j])}}},$["bg"+e[0].toUpperCase()+e.slice(1)]={get(){const{level:t}=this;return function(...o){const r=V(H(e,x[t],"bgColor",...o),_.bgColor.close,this[G]);return K(this,r,this[j])}}};const U=Object.defineProperties((()=>{}),{...$,level:{enumerable:!0,get(){return this[k].level},set(e){this[k].level=e}}}),V=(e,t,o)=>{let r,i;return void 0===o?(r=e,i=t):(r=o.openAll+e,i=t+o.closeAll),{open:e,close:t,openAll:r,closeAll:i,parent:o}},K=(e,t,o)=>{const r=(...e)=>W(r,1===e.length?""+e[0]:e.join(" "));return Object.setPrototypeOf(r,U),r[k]=e,r[G]=t,r[j]=o,r},W=(e,t)=>{if(e.level<=0||!t)return e[j]?"":t;let o=e[G];if(void 0===o)return t;const{openAll:r,closeAll:i}=o;if(t.includes(""))for(;void 0!==o;)t=M(t,o.close,o.open),o=o.parent;const n=t.indexOf("\n");return-1!==n&&(t=function(e,t,o,r){let i=0,n="";do{const s="\r"===e[r-1];n+=e.slice(i,s?r-1:r)+t+(s?"\r\n":"\n")+o,i=r+1,r=e.indexOf("\n",i)}while(-1!==r);return n+=e.slice(i),n}(t,i,r,n)),r+t+i};Object.defineProperties(Y.prototype,$);const Q=Y();Y({level:B?B.level:0});const X={all:0,debug:1,deviceEvent:2,info:3,warn:4,error:5,fatal:98,none:99},q={host:"",logLevel:"all",prompt:" => ",showTime:!1,symbol:{debug:"dbg",info:"",deviceEvent:"",warn:"(!)",error:"[!]",fatal:"{x_X}"},terminal:!0},z={debug:Q.gray,info:Q.white,deviceEvent:Q.green,warn:Q.yellow,error:Q.red,fatal:Q.redBright};function J(e,t){return o(e,{colors:!0,depth:t})}function Z(e){return o(e,{colors:!0,depth:2})}class ee{_debug=()=>{};_info=()=>{};_deviceEvent=()=>{};_warn=()=>{};_error=()=>{};_fatal=()=>{};_defaultLogger(e,t){console.log(e)}prompt=" => ";host="";logLevel="all";terminal=!0;showTime=!1;showMillis=!1;get time(){const e=new Date;let t="",o="",r="";e.getHours()<10&&(t="0"),e.getMinutes()<10&&(o="0"),e.getSeconds()<10&&(r="0"),t+=e.getHours(),o+=e.getMinutes(),r+=e.getSeconds();let i=t+":"+o+":"+r;return this.showMillis&&(i+=":"+e.getMilliseconds()),Q.grey(i)}ps(e){let t="";return!0===this.showTime&&(t+=this.time+" "),""!==this.symbol[e]&&(t+=z[e](this.symbol[e])+" "),t+=z[e](this.host)+this.prompt,t}symbol;assignOptions(e,t){for(const o in t)"object"!=typeof e[o]?e[o]=t[o]||e[o]:this.assignOptions(e[o],t[o])}getLevelLoggers(){return{debug:this._debug,info:this._info,deviceEvent:this._deviceEvent,warn:this._warn,error:this._error,fatal:this._fatal}}logger=this._defaultLogger;resetLogger(){this.logger=this._defaultLogger}constructor(e=q){const t=S(e,q);this.assignOptions(this,t),this.spawnLevelLoggers()}spawnLevelLoggers(){for(let e in this.symbol){let t=e;this["_"+e]=e=>{let o=`${this.ps(t)}${r=e,"string"==typeof r?r:Z(r)}`;var r;return X[this.logLevel]<=X[t]&&this.logger(o,t),o}}}}const te=/(^|[/\\])([^/\\]+?)(?=(\.[^.]+)?$)/;const oe=(e=0)=>t=>`[${t+e}m`,re=(e=0)=>t=>`[${38+e};5;${t}m`,ie=(e=0)=>(t,o,r)=>`[${38+e};2;${t};${o};${r}m`,ne={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(ne.modifier);Object.keys(ne.color),Object.keys(ne.bgColor);const se=function(){const e=new Map;for(const[t,o]of Object.entries(ne)){for(const[t,r]of Object.entries(o))ne[t]={open:`[${r[0]}m`,close:`[${r[1]}m`},o[t]=ne[t],e.set(r[0],r[1]);Object.defineProperty(ne,t,{value:o,enumerable:!1})}return Object.defineProperty(ne,"codes",{value:e,enumerable:!1}),ne.color.close="[39m",ne.bgColor.close="[49m",ne.color.ansi=oe(),ne.color.ansi256=re(),ne.color.ansi16m=ie(),ne.bgColor.ansi=oe(10),ne.bgColor.ansi256=re(10),ne.bgColor.ansi16m=ie(10),Object.defineProperties(ne,{rgbToAnsi256:{value:(e,t,o)=>e===t&&t===o?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(o/255*5),enumerable:!1},hexToRgb:{value(e){const t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(e.toString(16));if(!t)return[0,0,0];let[o]=t;3===o.length&&(o=[...o].map((e=>e+e)).join(""));const r=Number.parseInt(o,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>ne.rgbToAnsi256(...ne.hexToRgb(e)),enumerable:!1},ansi256ToAnsi:{value(e){if(e<8)return 30+e;if(e<16)return e-8+90;let t,o,r;if(e>=232)t=(10*(e-232)+8)/255,o=t,r=t;else{const i=(e-=16)%36;t=Math.floor(e/36)/5,o=Math.floor(i/6)/5,r=i%6/5}const i=2*Math.max(t,o,r);if(0===i)return 30;let n=30+(Math.round(r)<<2|Math.round(o)<<1|Math.round(t));return 2===i&&(n+=60),n},enumerable:!1},rgbToAnsi:{value:(e,t,o)=>ne.ansi256ToAnsi(ne.rgbToAnsi256(e,t,o)),enumerable:!1},hexToAnsi:{value:e=>ne.ansi256ToAnsi(ne.hexToAnsi256(e)),enumerable:!1}}),ne}();function le(e,t=(globalThis.Deno?globalThis.Deno.args:r.argv)){const o=e.startsWith("-")?"":1===e.length?"-":"--",i=t.indexOf(o+e),n=t.indexOf("--");return-1!==i&&(-1===n||i<n)}const{env:ae}=r;let ce;function he(e,{streamIsTTY:t,sniffFlags:o=!0}={}){const n=function(){if("FORCE_COLOR"in ae)return"true"===ae.FORCE_COLOR?1:"false"===ae.FORCE_COLOR?0:0===ae.FORCE_COLOR.length?1:Math.min(Number.parseInt(ae.FORCE_COLOR,10),3)}();void 0!==n&&(ce=n);const s=o?ce:n;if(0===s)return 0;if(o){if(le("color=16m")||le("color=full")||le("color=truecolor"))return 3;if(le("color=256"))return 2}if("TF_BUILD"in ae&&"AGENT_NAME"in ae)return 1;if(e&&!t&&void 0===s)return 0;const l=s||0;if("dumb"===ae.TERM)return l;if("win32"===r.platform){const e=i.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in ae)return"GITHUB_ACTIONS"in ae?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some((e=>e in ae))||"codeship"===ae.CI_NAME?1:l;if("TEAMCITY_VERSION"in ae)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(ae.TEAMCITY_VERSION)?1:0;if("truecolor"===ae.COLORTERM)return 3;if("xterm-kitty"===ae.TERM)return 3;if("TERM_PROGRAM"in ae){const e=Number.parseInt((ae.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(ae.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(ae.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(ae.TERM)||"COLORTERM"in ae?1:l}function ue(e,t={}){return function(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}(he(e,{streamIsTTY:e&&e.isTTY,...t}))}le("no-color")||le("no-colors")||le("color=false")||le("color=never")?ce=0:(le("color")||le("colors")||le("color=true")||le("color=always"))&&(ce=1);const fe={stdout:ue({isTTY:n.isatty(1)}),stderr:ue({isTTY:n.isatty(2)})};function ge(e,t,o){let r=e.indexOf(t);if(-1===r)return e;const i=t.length;let n=0,s="";do{s+=e.slice(n,r)+t+o,n=r+i,r=e.indexOf(t,n)}while(-1!==r);return s+=e.slice(n),s}const{stdout:de,stderr:Ee}=fe,be=Symbol("GENERATOR"),pe=Symbol("STYLER"),me=Symbol("IS_EMPTY"),Te=["ansi","ansi","ansi256","ansi16m"],ve=Object.create(null),Se=e=>{const t=(...e)=>e.join(" ");return((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const o=de?de.level:0;e.level=void 0===t.level?o:t.level})(t,e),Object.setPrototypeOf(t,Re.prototype),t};function Re(e){return Se(e)}Object.setPrototypeOf(Re.prototype,Function.prototype);for(const[e,t]of Object.entries(se))ve[e]={get(){const o=ye(this,_e(t.open,t.close,this[pe]),this[me]);return Object.defineProperty(this,e,{value:o}),o}};ve.visible={get(){const e=ye(this,this[pe],!0);return Object.defineProperty(this,"visible",{value:e}),e}};const Ce=(e,t,o,...r)=>"rgb"===e?"ansi16m"===t?se[o].ansi16m(...r):"ansi256"===t?se[o].ansi256(se.rgbToAnsi256(...r)):se[o].ansi(se.rgbToAnsi(...r)):"hex"===e?Ce("rgb",t,o,...se.hexToRgb(...r)):se[o][e](...r),Ae=["rgb","hex","ansi256"];for(const e of Ae){ve[e]={get(){const{level:t}=this;return function(...o){const r=_e(Ce(e,Te[t],"color",...o),se.color.close,this[pe]);return ye(this,r,this[me])}}};ve["bg"+e[0].toUpperCase()+e.slice(1)]={get(){const{level:t}=this;return function(...o){const r=_e(Ce(e,Te[t],"bgColor",...o),se.bgColor.close,this[pe]);return ye(this,r,this[me])}}}}const Oe=Object.defineProperties((()=>{}),{...ve,level:{enumerable:!0,get(){return this[be].level},set(e){this[be].level=e}}}),_e=(e,t,o)=>{let r,i;return void 0===o?(r=e,i=t):(r=o.openAll+e,i=t+o.closeAll),{open:e,close:t,openAll:r,closeAll:i,parent:o}},ye=(e,t,o)=>{const r=(...e)=>Ne(r,1===e.length?""+e[0]:e.join(" "));return Object.setPrototypeOf(r,Oe),r[be]=e,r[pe]=t,r[me]=o,r},Ne=(e,t)=>{if(e.level<=0||!t)return e[me]?"":t;let o=e[pe];if(void 0===o)return t;const{openAll:r,closeAll:i}=o;if(t.includes(""))for(;void 0!==o;)t=ge(t,o.close,o.open),o=o.parent;const n=t.indexOf("\n");return-1!==n&&(t=function(e,t,o,r){let i=0,n="";do{const s="\r"===e[r-1];n+=e.slice(i,s?r-1:r)+t+(s?"\r\n":"\n")+o,i=r+1,r=e.indexOf("\n",i)}while(-1!==r);return n+=e.slice(i),n}(t,i,r,n)),r+t+i};Object.defineProperties(Re.prototype,ve);const De=Re();function Ie(e){return null!==e&&"object"==typeof e}function Pe(e,t,o=".",r){if(!Ie(t))return Pe(e,{},o,r);const i=Object.assign({},t);for(const t in e){if("__proto__"===t||"constructor"===t)continue;const n=e[t];null!=n&&(r&&r(i,t,n,o)||(Array.isArray(n)&&Array.isArray(i[t])?i[t]=[...n,...i[t]]:Ie(n)&&Ie(i[t])?i[t]=Pe(n,i[t],(o?`${o}.`:"")+t.toString(),r):i[t]=n))}return i}Re({level:Ee?Ee.level:0});const we=(...e)=>e.reduce(((e,t)=>Pe(e,t,"",Me)),{});var Me;let Le=0;var Be;!function(e){e[e.PING=0]="PING",e[e.ACK=1]="ACK",e[e.READY=2]="READY",e[e.STATE_UPDATE=3]="STATE_UPDATE",e[e.ERROR=4]="ERROR",e[e.STRING=5]="STRING",e[e.DISCONNECT=6]="DISCONNECT"}(Be||(Be={}));const ke={portInfo:{},logLevel:"all",id:"",showTime:!1};class Ge extends s{serialPort;slipEncoder=new c.SlipEncoder(He);slipDecoder=new c.SlipDecoder(He);_prevAckTime=0;prevState={buttons:[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],dials:[0,0,0,0],dialsRelative:[0,0,0,0]};_deviceReady=!1;_id="";_portInfo=null;_msger;keepAliveTimer;static get connectedDevices(){return Le}get prevAckTime(){return this._prevAckTime}get isOpen(){return void 0!==this.serialPort&&this.serialPort.isOpen}get devicePath(){return null!==this._portInfo?this._portInfo.path:""}get deviceSerial(){return this._id}get fingerPrint(){return{devicePath:this.devicePath,deviceSerial:this.deviceSerial,portId:this.portId}}get portInfo(){return this._portInfo}get portId(){return null!==this._portInfo?this._portInfo.serialNumber:""}log;debug;deviceEvent;info;warn;error;fatal;get host(){let e="Port:"+De.green((t=this.devicePath,t.match(te)?.[2]))+"|";var t;return this._deviceReady?e+=De.magenta(this.deviceSerial.slice(0,4)):e+=De.yellow("D/C"),e}_logLevel="all";get showTime(){return this._msger.showTime}set showTime(e){this._msger.showTime=e}get logLevel(){return this._logLevel}set logLevel(e){this._logLevel=e,this._msger.logLevel=e}get logTermFormat(){return this._msger.terminal}set logTermFormat(e){this._msger.terminal=e}emitLog=(e,t)=>{this.emit(je.Terminal.Log[t],{level:t,message:e,buffer:l.from(e)})};constructor(e){super();const t=we(e,ke);this._portInfo=t.portInfo,this._msger=new ee,this._msger.host=this.host,this._msger.showTime=t.showTime,this.log=this._msger.getLevelLoggers(),this.logLevel=t.logLevel;for(const e in this.log)this[e]=t=>{const o=this.log[e](t);this.emitLog(o,e)};this.debug("Creating new MakeShiftPort with options: "+Z(t)),this.slipDecoder.on("data",(e=>{this.parseSlipPacketHeader(e)})),this.open()}parseSlipPacketHeader(e){this._prevAckTime=Date.now();const t=e.subarray(0,1).at(0),o=e.subarray(1);switch(this.debug(e),t){case Be.STATE_UPDATE:{let e=Ge.parseStateFromBuffer(o);this.emit(je.DEVICE.STATE_UPDATE,e),this.handleStateUpdate(e);break}case Be.ACK:this.debug("Got ACK from MakeShift");break;case Be.STRING:this.debug(o.toString());break;case Be.PING:this.debug("Got PING from MakeShift, responding with ACK"),this.sendByte(Be.ACK);break;case Be.ERROR:this.debug("Got ERROR from MakeShift");break;case Be.READY:this.debug("Got READY from MakeShift"),this.debug(o.toString()),Le++,this._deviceReady=!0,this._id=o.toString().replaceAll("-",""),this._msger.host=this.host,this._prevAckTime=Date.now(),this.deviceEvent("Device connection established"),this.emit(je.DEVICE.CONNECTED,this.fingerPrint);break;default:this.debug(t),this.debug(e.toString())}}ping(){this.sendByte(Be.PING)}handleStateUpdate(e){for(let t=0;t<$e;t++)if(e.buttons[t]!=this.prevState.buttons[t]){let o;o=!0===e.buttons[t]?je.BUTTON[t].PRESSED:je.BUTTON[t].RELEASED,this.emit(o,{state:e,event:o}),this.deviceEvent(`${o} with state ${e.buttons[t]}`)}for(let t=0;t<Ye;t++)if(e.dials[t],this.prevState.dials[t],0!==e.dialsRelative[t]){let o;this.emit(je.DIAL[t].CHANGE,{state:e,event:o}),o=e.dialsRelative[t]>0?je.DIAL[t].INCREMENT:je.DIAL[t].DECREMENT,this.emit(o,{state:e,event:o}),this.deviceEvent(`${o} with state ${e.dials[t]}`)}this.prevState=e}sendByte(e){if(this.isOpen)try{this.serialPort.flush();let t=l.from([e]);this.debug(`Sending byte: ${Z(t)}`),this.slipEncoder.write(t)}catch(e){this.error(e)}}send(e,t){if(this.isOpen)try{this.serialPort.flush();let o=l.from([e]),r=l.from(t);const i=l.concat([o,r]);this.debug(`Sending buffer: ${Z(i)}`),this.slipEncoder.write(i)}catch(e){this.error(e)}}static parseStateFromBuffer(e){let t={buttons:[],dials:[],dialsRelative:[]};const o=e.subarray(0,2).reverse(),r=e.subarray(2,6),i=e.subarray(6);function n(e,o){0!==o&&(e%2?t.buttons.push(!0):t.buttons.push(!1),n(Math.floor(e/2),o-1))}o.forEach((e=>n(e,8)));for(let e=0;e<4;e++)t.dialsRelative.push(r.readInt8(e));return t.dials.push(i.readInt32BE(0)),t.dials.push(i.readInt32BE(4)),t.dials.push(i.readInt32BE(8)),t.dials.push(i.readInt32BE(12)),t}async open(){this.serialPort=await new e({path:this.devicePath,baudRate:42069},(e=>{null!=e?(this.error("Something happened while opening port: "),this.error(e),this.emit(je.DEVICE.CONNECTION_ERROR,e)):(this._msger.host=this.host,this.info("SerialPort opened, attaching SLIP translators"),this.slipEncoder.pipe(this.serialPort),this.serialPort.pipe(this.slipDecoder),this.info("Translators ready, sending READY to MakeShift"),this.sendByte(Be.READY))}))}close(){this.info("Closing MakeShift port..."),this.info("Unpiping encoders"),this.slipEncoder.unpipe(),this.serialPort.unpipe(),this.isOpen&&(this.info("Port object found open"),this.info("Sending disconnect packet"),this.sendByte(Be.DISCONNECT),this.info("Closing port"),this.serialPort.close()),this._msger.host=this.host,Le--,this._deviceReady=!1,this.warn("Port closed, sending disconnect signal"),this.emit(je.DEVICE.DISCONNECTED,this.fingerPrint)}write=e=>{this._deviceReady?this.send(Be.STRING,e):this.info("MakeShift not ready, line not sent")}}const je={DIAL:[{INCREMENT:"dial-01-increment",DECREMENT:"dial-01-decrement",CHANGE:"dial-01-change"},{INCREMENT:"dial-02-increment",DECREMENT:"dial-02-decrement",CHANGE:"dial-02-change"},{INCREMENT:"dial-03-increment",DECREMENT:"dial-03-decrement",CHANGE:"dial-03-change"},{INCREMENT:"dial-04-increment",DECREMENT:"dial-04-decrement",CHANGE:"dial-04-change"}],BUTTON:[{PRESSED:"button-01-rise",RELEASED:"button-01-fall",CHANGE:"button-01-change"},{PRESSED:"button-02-rise",RELEASED:"button-02-fall",CHANGE:"button-02-change"},{PRESSED:"button-03-rise",RELEASED:"button-03-fall",CHANGE:"button-03-change"},{PRESSED:"button-04-rise",RELEASED:"button-04-fall",CHANGE:"button-04-change"},{PRESSED:"button-05-rise",RELEASED:"button-05-fall",CHANGE:"button-05-change"},{PRESSED:"button-06-rise",RELEASED:"button-06-fall",CHANGE:"button-06-change"},{PRESSED:"button-07-rise",RELEASED:"button-07-fall",CHANGE:"button-07-change"},{PRESSED:"button-08-rise",RELEASED:"button-08-fall",CHANGE:"button-08-change"},{PRESSED:"button-09-rise",RELEASED:"button-09-fall",CHANGE:"button-09-change"},{PRESSED:"button-10-rise",RELEASED:"button-10-fall",CHANGE:"button-10-change"},{PRESSED:"button-11-rise",RELEASED:"button-11-fall",CHANGE:"button-11-change"},{PRESSED:"button-12-rise",RELEASED:"button-12-fall",CHANGE:"button-12-change"},{PRESSED:"button-13-rise",RELEASED:"button-13-fall",CHANGE:"button-13-change"},{PRESSED:"button-14-rise",RELEASED:"button-14-fall",CHANGE:"button-14-change"},{PRESSED:"button-15-rise",RELEASED:"button-15-fall",CHANGE:"button-15-change"},{PRESSED:"button-16-rise",RELEASED:"button-16-fall",CHANGE:"button-16-change"}],DEVICE:{CONNECTION_ERROR:"makeshift-connection-error",DISCONNECTED:"makeshift-disconnect",CONNECTED:"makeshift-connect",STATE_UPDATE:"state-update"},Terminal:{Log:{fatal:"makeshift-serial-log-fatal",error:"makeshift-serial-log-error",warn:"makeshift-serial-log-warn",deviceEvent:"makeshift-serial-log-event",info:"makeshift-serial-log-info",debug:"makeshift-serial-log-debug",all:"makeshift-serial-log-any"}}};const xe=function e(t){const o=[];for(const r in t){if("string"==typeof t[r])return t[r];{const i=e(t[r]);Array.isArray(i)?o.push(...i):o.push(i)}}return o}(je),$e=je.BUTTON.length,Ye=je.DIAL.length,He={ESC:219,END:192,ESC_END:220,ESC_ESC:221},Fe={};let Ue=[];const Ve=new s;let Ke="info",We=!1,Qe=!0,Xe=1e3,qe=5e3,ze=1500;const Je={},Ze=new ee({host:"PortAuthority",logLevel:"info",showTime:!1});Ze.logLevel=Ke,Ze.showTime=We;const et=Ze.getLevelLoggers();function tt(){Qe=!0,ct()}function ot(){Qe=!1}function rt(){Qe=!1,ut()}function it(){return Ue}function nt(e){We=e,Ze.showTime=e;for(const t in Fe)Fe[t].showTime=e}function st(e){Ke=e,Ze.logLevel=e;for(const t in Fe)Fe[t].logLevel=e}function lt(e,t){void 0!==Fe[e]&&(Fe[e].logLevel=t)}function at(e){Ze.logLevel=e}function ct(){setTimeout((()=>{ut()}),Xe),Ve.emit(ft.scan.started)}function ht(e){Je[e]=setTimeout((()=>{!function(e){const t=Date.now()-Fe[e].prevAckTime;et.debug(`elapsedTime since prevAckTime: ${t}`),t>qe?(clearTimeout(Je[e]),et.debug(`Timer handle - ${Je[e]}`),et.warn(`Device ${e}::${Fe[e].devicePath} unresponsive for ${qe}ms, disconnecting`),function(e){if(void 0===Fe[e])return;const t=Fe[e].fingerPrint;Ue=Ue.filter((e=>t.devicePath!==e.devicePath&&t.deviceSerial!==e.deviceSerial)),Fe[e].close(),delete Fe[e],Ve.emit(ft.port.closed,t)}(e)):(t>=ze-40&&Fe[e].ping(),ht(e))}(e)}),ze)}async function ut(){et.debug(`scanForDevice called with autoscan set to ${Qe}`);try{const t=await e.list();t.forEach((e=>{et.debug(J(e,1))}));const o=t.filter((e=>("16c0"===e.vendorId||"16C0"===e.vendorId)&&"0483"===e.productId));et.debug(`Found MakeShift devices: ${Z(o)}`),o.length>0&&o.forEach((e=>{!function(e){const t=e.path;for(const e in Fe)if(Fe[e].devicePath===t)return;const o={portInfo:e,logLevel:Ke,showTime:We};et.info(`Opening device with options: '${J(o,1)}'`);let r=new Ge(o);r.once(je.DEVICE.CONNECTED,(e=>{const t=e.deviceSerial;Fe[t]=r,Ue.push(e),Fe[t].ping(),ht(t),et.deviceEvent(`Opened port ${e.devicePath}, with deviceSerial ${De.magenta(e.deviceSerial)}`),Ve.emit(ft.port.opened,e)})),r.once(je.DEVICE.CONNECTION_ERROR,(e=>{et.error(`Error opening device on port ${t}: ${e.message}`)}))}(e)})),Qe?ct():Ve.emit(ft.scan.stopped)}catch(e){et.error(e)}}const ft={port:{opened:"makeshift-pa-port-opened",closed:"makeshift-pa-port-closed"},scan:{started:"makeshift-pa-scan-started",stopped:"makeshift-pa-scan-stopped"}};export{je as DeviceEvents,xe as DeviceEventsFlat,Ge as MakeShiftPort,ee as Msg,Be as PacketType,Ve as PortAuthority,ft as PortAuthorityEvents,Fe as Ports,ke as defaultMakeShiftPortOptions,it as getPortFingerPrintSnapShot,Z as nspct2,J as nspect,Xe as scanDelayMs,rt as scanOnce,st as setLogLevel,at as setPortAuthorityLogLevel,lt as setPortLogLevel,nt as setShowTime,tt as startAutoScan,ot as stopAutoScan};
