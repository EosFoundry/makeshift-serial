import{SerialPort as e}from"serialport";import t from"stream";import{inspect as r}from"node:util";import o from"node:process";import i from"node:os";import s from"node:tty";import{EventEmitter as n}from"node:events";import{Buffer as l}from"node:buffer";import{readFileSync as a}from"fs";import{fileURLToPath as c}from"url";import{dirname as h,join as u}from"path";var f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},g={},d={};Object.defineProperty(d,"__esModule",{value:!0}),d.SlipDecoder=void 0;const p=t;class b extends p.Transform{constructor(e={}){super(e);const{START:t,ESC:r=219,END:o=192,ESC_START:i,ESC_END:s=220,ESC_ESC:n=221}=e;this.opts={START:t,ESC:r,END:o,ESC_START:i,ESC_END:s,ESC_ESC:n},this.buffer=Buffer.alloc(0),this.escape=!1,this.start=!1}_transform(e,t,r){for(let t=0;t<e.length;t++){let r=e[t];if(r!==this.opts.START){if(null==this.opts.START&&(this.start=!0),this.escape)r===this.opts.ESC_START&&this.opts.START?r=this.opts.START:r===this.opts.ESC_ESC?r=this.opts.ESC:r===this.opts.ESC_END?r=this.opts.END:(this.escape=!1,this.push(this.buffer),this.buffer=Buffer.alloc(0));else{if(r===this.opts.ESC){this.escape=!0;continue}if(r===this.opts.END){this.push(this.buffer),this.buffer=Buffer.alloc(0),this.escape=!1,this.start=!1;continue}}this.escape=!1,this.start&&(this.buffer=Buffer.concat([this.buffer,Buffer.from([r])]))}else this.start=!0}r()}_flush(e){this.push(this.buffer),this.buffer=Buffer.alloc(0),e()}}d.SlipDecoder=b;var m={};Object.defineProperty(m,"__esModule",{value:!0}),m.SlipEncoder=void 0;const T=t;class v extends T.Transform{constructor(e={}){super(e);const{START:t,ESC:r=219,END:o=192,ESC_START:i,ESC_END:s=220,ESC_ESC:n=221,bluetoothQuirk:l=!1}=e;this.opts={START:t,ESC:r,END:o,ESC_START:i,ESC_END:s,ESC_ESC:n,bluetoothQuirk:l}}_transform(e,t,r){const o=e.length;if(this.opts.bluetoothQuirk&&0===o)return r();const i=Buffer.alloc(2*o+2);let s=0;1==this.opts.bluetoothQuirk&&(i[s++]=this.opts.END),void 0!==this.opts.START&&(i[s++]=this.opts.START);for(let t=0;t<o;t++){let r=e[t];r===this.opts.START&&this.opts.ESC_START?(i[s++]=this.opts.ESC,r=this.opts.ESC_START):r===this.opts.END?(i[s++]=this.opts.ESC,r=this.opts.ESC_END):r===this.opts.ESC&&(i[s++]=this.opts.ESC,r=this.opts.ESC_ESC),i[s++]=r}i[s++]=this.opts.END,r(null,i.slice(0,s))}}var E,O,R;function C(e){return null!==e&&"object"==typeof e}function S(e,t,r=".",o){if(!C(t))return S(e,{},r,o);const i=Object.assign({},t);for(const t in e){if("__proto__"===t||"constructor"===t)continue;const s=e[t];null!=s&&(o&&o(i,t,s,r)||(Array.isArray(s)&&Array.isArray(i[t])?i[t]=[...s,...i[t]]:C(s)&&C(i[t])?i[t]=S(s,i[t],(r?`${r}.`:"")+t.toString(),o):i[t]=s))}return i}m.SlipEncoder=v,E=g,O=f&&f.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),R=f&&f.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||O(t,e,r)},Object.defineProperty(E,"__esModule",{value:!0}),R(d,E),R(m,E);const _=(...e)=>e.reduce(((e,t)=>S(e,t,"",undefined)),{});const A=(e=0)=>t=>`[${t+e}m`,y=(e=0)=>t=>`[${38+e};5;${t}m`,I=(e=0)=>(t,r,o)=>`[${38+e};2;${t};${r};${o}m`,w={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(w.modifier),Object.keys(w.color),Object.keys(w.bgColor);const N=function(){const e=new Map;for(const[t,r]of Object.entries(w)){for(const[t,o]of Object.entries(r))w[t]={open:`[${o[0]}m`,close:`[${o[1]}m`},r[t]=w[t],e.set(o[0],o[1]);Object.defineProperty(w,t,{value:r,enumerable:!1})}return Object.defineProperty(w,"codes",{value:e,enumerable:!1}),w.color.close="[39m",w.bgColor.close="[49m",w.color.ansi=A(),w.color.ansi256=y(),w.color.ansi16m=I(),w.bgColor.ansi=A(10),w.bgColor.ansi256=y(10),w.bgColor.ansi16m=I(10),Object.defineProperties(w,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value(e){const t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(e.toString(16));if(!t)return[0,0,0];let[r]=t;3===r.length&&(r=[...r].map((e=>e+e)).join(""));const o=Number.parseInt(r,16);return[o>>16&255,o>>8&255,255&o]},enumerable:!1},hexToAnsi256:{value:e=>w.rgbToAnsi256(...w.hexToRgb(e)),enumerable:!1},ansi256ToAnsi:{value(e){if(e<8)return 30+e;if(e<16)return e-8+90;let t,r,o;if(e>=232)t=(10*(e-232)+8)/255,r=t,o=t;else{const i=(e-=16)%36;t=Math.floor(e/36)/5,r=Math.floor(i/6)/5,o=i%6/5}const i=2*Math.max(t,r,o);if(0===i)return 30;let s=30+(Math.round(o)<<2|Math.round(r)<<1|Math.round(t));return 2===i&&(s+=60),s},enumerable:!1},rgbToAnsi:{value:(e,t,r)=>w.ansi256ToAnsi(w.rgbToAnsi256(e,t,r)),enumerable:!1},hexToAnsi:{value:e=>w.ansi256ToAnsi(w.hexToAnsi256(e)),enumerable:!1}}),w}();function M(e,t=(globalThis.Deno?globalThis.Deno.args:o.argv)){const r=e.startsWith("-")?"":1===e.length?"-":"--",i=t.indexOf(r+e),s=t.indexOf("--");return-1!==i&&(-1===s||i<s)}const{env:P}=o;let D;function B(e,{streamIsTTY:t,sniffFlags:r=!0}={}){const s=function(){if("FORCE_COLOR"in P)return"true"===P.FORCE_COLOR?1:"false"===P.FORCE_COLOR?0:0===P.FORCE_COLOR.length?1:Math.min(Number.parseInt(P.FORCE_COLOR,10),3)}();void 0!==s&&(D=s);const n=r?D:s;if(0===n)return 0;if(r){if(M("color=16m")||M("color=full")||M("color=truecolor"))return 3;if(M("color=256"))return 2}if("TF_BUILD"in P&&"AGENT_NAME"in P)return 1;if(e&&!t&&void 0===n)return 0;const l=n||0;if("dumb"===P.TERM)return l;if("win32"===o.platform){const e=i.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in P)return"GITHUB_ACTIONS"in P?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some((e=>e in P))||"codeship"===P.CI_NAME?1:l;if("TEAMCITY_VERSION"in P)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(P.TEAMCITY_VERSION)?1:0;if("truecolor"===P.COLORTERM)return 3;if("xterm-kitty"===P.TERM)return 3;if("TERM_PROGRAM"in P){const e=Number.parseInt((P.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(P.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(P.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(P.TERM)||"COLORTERM"in P?1:l}function L(e,t={}){return function(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}(B(e,{streamIsTTY:e&&e.isTTY,...t}))}M("no-color")||M("no-colors")||M("color=false")||M("color=never")?D=0:(M("color")||M("colors")||M("color=true")||M("color=always"))&&(D=1);const k={stdout:L({isTTY:s.isatty(1)}),stderr:L({isTTY:s.isatty(2)})};function j(e,t,r){let o=e.indexOf(t);if(-1===o)return e;const i=t.length;let s=0,n="";do{n+=e.slice(s,o)+t+r,s=o+i,o=e.indexOf(t,s)}while(-1!==o);return n+=e.slice(s),n}const{stdout:x,stderr:$}=k,G=Symbol("GENERATOR"),Y=Symbol("STYLER"),F=Symbol("IS_EMPTY"),U=["ansi","ansi","ansi256","ansi16m"],V=Object.create(null);function H(e){return(e=>{const t=(...e)=>e.join(" ");return((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const r=x?x.level:0;e.level=void 0===t.level?r:t.level})(t,e),Object.setPrototypeOf(t,H.prototype),t})(e)}Object.setPrototypeOf(H.prototype,Function.prototype);for(const[e,t]of Object.entries(N))V[e]={get(){const r=X(this,J(t.open,t.close,this[Y]),this[F]);return Object.defineProperty(this,e,{value:r}),r}};V.visible={get(){const e=X(this,this[Y],!0);return Object.defineProperty(this,"visible",{value:e}),e}};const K=(e,t,r,...o)=>"rgb"===e?"ansi16m"===t?N[r].ansi16m(...o):"ansi256"===t?N[r].ansi256(N.rgbToAnsi256(...o)):N[r].ansi(N.rgbToAnsi(...o)):"hex"===e?K("rgb",t,r,...N.hexToRgb(...o)):N[r][e](...o),W=["rgb","hex","ansi256"];for(const e of W)V[e]={get(){const{level:t}=this;return function(...r){const o=J(K(e,U[t],"color",...r),N.color.close,this[Y]);return X(this,o,this[F])}}},V["bg"+e[0].toUpperCase()+e.slice(1)]={get(){const{level:t}=this;return function(...r){const o=J(K(e,U[t],"bgColor",...r),N.bgColor.close,this[Y]);return X(this,o,this[F])}}};const Q=Object.defineProperties((()=>{}),{...V,level:{enumerable:!0,get(){return this[G].level},set(e){this[G].level=e}}}),J=(e,t,r)=>{let o,i;return void 0===r?(o=e,i=t):(o=r.openAll+e,i=t+r.closeAll),{open:e,close:t,openAll:o,closeAll:i,parent:r}},X=(e,t,r)=>{const o=(...e)=>q(o,1===e.length?""+e[0]:e.join(" "));return Object.setPrototypeOf(o,Q),o[G]=e,o[Y]=t,o[F]=r,o},q=(e,t)=>{if(e.level<=0||!t)return e[F]?"":t;let r=e[Y];if(void 0===r)return t;const{openAll:o,closeAll:i}=r;if(t.includes(""))for(;void 0!==r;)t=j(t,r.close,r.open),r=r.parent;const s=t.indexOf("\n");return-1!==s&&(t=function(e,t,r,o){let i=0,s="";do{const n="\r"===e[o-1];s+=e.slice(i,n?o-1:o)+t+(n?"\r\n":"\n")+r,i=o+1,o=e.indexOf("\n",i)}while(-1!==o);return s+=e.slice(i),s}(t,i,o,s)),o+t+i};Object.defineProperties(H.prototype,V);const z=H();H({level:$?$.level:0});const Z={all:0,debug:1,deviceEvent:2,info:3,warn:4,error:5,fatal:98,none:99},ee={host:"",logLevel:"all",prompt:" => ",showTime:!1,symbol:{debug:"dbg",info:"",deviceEvent:"",warn:"(!)",error:"[!]",fatal:"{x_X}"},terminal:!0},te={debug:z.gray,info:z.white,deviceEvent:z.green,warn:z.yellow,error:z.red,fatal:z.redBright};function re(e,t){return r(e,{colors:!0,depth:t})}function oe(e){return r(e,{colors:!0,depth:2})}class ie{_debug=()=>{};_info=()=>{};_deviceEvent=()=>{};_warn=()=>{};_error=()=>{};_fatal=()=>{};_defaultLogger(e,t){console.log(e)}prompt=" => ";host="";logLevel="all";terminal=!0;showTime=!1;showMillis=!1;get time(){const e=new Date;let t="",r="",o="";e.getHours()<10&&(t="0"),e.getMinutes()<10&&(r="0"),e.getSeconds()<10&&(o="0"),t+=e.getHours(),r+=e.getMinutes(),o+=e.getSeconds();let i=t+":"+r+":"+o;return this.showMillis&&(i+=":"+e.getMilliseconds()),z.grey(i)}ps(e){let t="";return!0===this.showTime&&(t+=this.time+" "),""!==this.symbol[e]&&(t+=te[e](this.symbol[e])+" "),t+=te[e](this.host)+this.prompt,t}symbol;assignOptions(e,t){for(const r in t)"object"!=typeof e[r]?e[r]=t[r]||e[r]:this.assignOptions(e[r],t[r])}getLevelLoggers(){return{debug:this._debug,info:this._info,deviceEvent:this._deviceEvent,warn:this._warn,error:this._error,fatal:this._fatal}}logger=this._defaultLogger;resetLogger(){this.logger=this._defaultLogger}constructor(e=ee){const t=_(e,ee);this.assignOptions(this,t),this.spawnLevelLoggers()}spawnLevelLoggers(){for(let e in this.symbol){let t=e;this["_"+e]=e=>{let r=`${this.ps(t)}${o=e,"string"==typeof o?o:oe(o)}`;var o;return Z[this.logLevel]<=Z[t]&&this.logger(r,t),r}}}}const se=/(^|[/\\])([^/\\]+?)(?=(\.[^.]+)?$)/;const ne=(e=0)=>t=>`[${t+e}m`,le=(e=0)=>t=>`[${38+e};5;${t}m`,ae=(e=0)=>(t,r,o)=>`[${38+e};2;${t};${r};${o}m`,ce={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(ce.modifier);Object.keys(ce.color),Object.keys(ce.bgColor);const he=function(){const e=new Map;for(const[t,r]of Object.entries(ce)){for(const[t,o]of Object.entries(r))ce[t]={open:`[${o[0]}m`,close:`[${o[1]}m`},r[t]=ce[t],e.set(o[0],o[1]);Object.defineProperty(ce,t,{value:r,enumerable:!1})}return Object.defineProperty(ce,"codes",{value:e,enumerable:!1}),ce.color.close="[39m",ce.bgColor.close="[49m",ce.color.ansi=ne(),ce.color.ansi256=le(),ce.color.ansi16m=ae(),ce.bgColor.ansi=ne(10),ce.bgColor.ansi256=le(10),ce.bgColor.ansi16m=ae(10),Object.defineProperties(ce,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value(e){const t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(e.toString(16));if(!t)return[0,0,0];let[r]=t;3===r.length&&(r=[...r].map((e=>e+e)).join(""));const o=Number.parseInt(r,16);return[o>>16&255,o>>8&255,255&o]},enumerable:!1},hexToAnsi256:{value:e=>ce.rgbToAnsi256(...ce.hexToRgb(e)),enumerable:!1},ansi256ToAnsi:{value(e){if(e<8)return 30+e;if(e<16)return e-8+90;let t,r,o;if(e>=232)t=(10*(e-232)+8)/255,r=t,o=t;else{const i=(e-=16)%36;t=Math.floor(e/36)/5,r=Math.floor(i/6)/5,o=i%6/5}const i=2*Math.max(t,r,o);if(0===i)return 30;let s=30+(Math.round(o)<<2|Math.round(r)<<1|Math.round(t));return 2===i&&(s+=60),s},enumerable:!1},rgbToAnsi:{value:(e,t,r)=>ce.ansi256ToAnsi(ce.rgbToAnsi256(e,t,r)),enumerable:!1},hexToAnsi:{value:e=>ce.ansi256ToAnsi(ce.hexToAnsi256(e)),enumerable:!1}}),ce}();function ue(e,t=(globalThis.Deno?globalThis.Deno.args:o.argv)){const r=e.startsWith("-")?"":1===e.length?"-":"--",i=t.indexOf(r+e),s=t.indexOf("--");return-1!==i&&(-1===s||i<s)}const{env:fe}=o;let ge;function de(e,{streamIsTTY:t,sniffFlags:r=!0}={}){const s=function(){if("FORCE_COLOR"in fe)return"true"===fe.FORCE_COLOR?1:"false"===fe.FORCE_COLOR?0:0===fe.FORCE_COLOR.length?1:Math.min(Number.parseInt(fe.FORCE_COLOR,10),3)}();void 0!==s&&(ge=s);const n=r?ge:s;if(0===n)return 0;if(r){if(ue("color=16m")||ue("color=full")||ue("color=truecolor"))return 3;if(ue("color=256"))return 2}if("TF_BUILD"in fe&&"AGENT_NAME"in fe)return 1;if(e&&!t&&void 0===n)return 0;const l=n||0;if("dumb"===fe.TERM)return l;if("win32"===o.platform){const e=i.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in fe)return"GITHUB_ACTIONS"in fe?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some((e=>e in fe))||"codeship"===fe.CI_NAME?1:l;if("TEAMCITY_VERSION"in fe)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(fe.TEAMCITY_VERSION)?1:0;if("truecolor"===fe.COLORTERM)return 3;if("xterm-kitty"===fe.TERM)return 3;if("TERM_PROGRAM"in fe){const e=Number.parseInt((fe.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(fe.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(fe.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(fe.TERM)||"COLORTERM"in fe?1:l}function pe(e,t={}){return function(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}(de(e,{streamIsTTY:e&&e.isTTY,...t}))}ue("no-color")||ue("no-colors")||ue("color=false")||ue("color=never")?ge=0:(ue("color")||ue("colors")||ue("color=true")||ue("color=always"))&&(ge=1);const be={stdout:pe({isTTY:s.isatty(1)}),stderr:pe({isTTY:s.isatty(2)})};function me(e,t,r){let o=e.indexOf(t);if(-1===o)return e;const i=t.length;let s=0,n="";do{n+=e.slice(s,o)+t+r,s=o+i,o=e.indexOf(t,s)}while(-1!==o);return n+=e.slice(s),n}const{stdout:Te,stderr:ve}=be,Ee=Symbol("GENERATOR"),Oe=Symbol("STYLER"),Re=Symbol("IS_EMPTY"),Ce=["ansi","ansi","ansi256","ansi16m"],Se=Object.create(null),_e=e=>{const t=(...e)=>e.join(" ");return((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const r=Te?Te.level:0;e.level=void 0===t.level?r:t.level})(t,e),Object.setPrototypeOf(t,Ae.prototype),t};function Ae(e){return _e(e)}Object.setPrototypeOf(Ae.prototype,Function.prototype);for(const[e,t]of Object.entries(he))Se[e]={get(){const r=Me(this,Ne(t.open,t.close,this[Oe]),this[Re]);return Object.defineProperty(this,e,{value:r}),r}};Se.visible={get(){const e=Me(this,this[Oe],!0);return Object.defineProperty(this,"visible",{value:e}),e}};const ye=(e,t,r,...o)=>"rgb"===e?"ansi16m"===t?he[r].ansi16m(...o):"ansi256"===t?he[r].ansi256(he.rgbToAnsi256(...o)):he[r].ansi(he.rgbToAnsi(...o)):"hex"===e?ye("rgb",t,r,...he.hexToRgb(...o)):he[r][e](...o),Ie=["rgb","hex","ansi256"];for(const e of Ie){Se[e]={get(){const{level:t}=this;return function(...r){const o=Ne(ye(e,Ce[t],"color",...r),he.color.close,this[Oe]);return Me(this,o,this[Re])}}};Se["bg"+e[0].toUpperCase()+e.slice(1)]={get(){const{level:t}=this;return function(...r){const o=Ne(ye(e,Ce[t],"bgColor",...r),he.bgColor.close,this[Oe]);return Me(this,o,this[Re])}}}}const we=Object.defineProperties((()=>{}),{...Se,level:{enumerable:!0,get(){return this[Ee].level},set(e){this[Ee].level=e}}}),Ne=(e,t,r)=>{let o,i;return void 0===r?(o=e,i=t):(o=r.openAll+e,i=t+r.closeAll),{open:e,close:t,openAll:o,closeAll:i,parent:r}},Me=(e,t,r)=>{const o=(...e)=>Pe(o,1===e.length?""+e[0]:e.join(" "));return Object.setPrototypeOf(o,we),o[Ee]=e,o[Oe]=t,o[Re]=r,o},Pe=(e,t)=>{if(e.level<=0||!t)return e[Re]?"":t;let r=e[Oe];if(void 0===r)return t;const{openAll:o,closeAll:i}=r;if(t.includes(""))for(;void 0!==r;)t=me(t,r.close,r.open),r=r.parent;const s=t.indexOf("\n");return-1!==s&&(t=function(e,t,r,o){let i=0,s="";do{const n="\r"===e[o-1];s+=e.slice(i,n?o-1:o)+t+(n?"\r\n":"\n")+r,i=o+1,o=e.indexOf("\n",i)}while(-1!==o);return s+=e.slice(i),s}(t,i,o,s)),o+t+i};Object.defineProperties(Ae.prototype,Se);const De=Ae();function Be(e){return null!==e&&"object"==typeof e}function Le(e,t,r=".",o){if(!Be(t))return Le(e,{},r,o);const i=Object.assign({},t);for(const t in e){if("__proto__"===t||"constructor"===t)continue;const s=e[t];null!=s&&(o&&o(i,t,s,r)||(Array.isArray(s)&&Array.isArray(i[t])?i[t]=[...s,...i[t]]:Be(s)&&Be(i[t])?i[t]=Le(s,i[t],(r?`${r}.`:"")+t.toString(),o):i[t]=s))}return i}Ae({level:ve?ve.level:0});const ke=(...e)=>e.reduce(((e,t)=>Le(e,t,"",je)),{});var je;const xe=h(c(import.meta.url)),$e=JSON.parse(a(u(xe,"../hardware-descriptors/generated/makeshift-events.json"),"utf8")),Ge={Log:{fatal:"makeshift-serial-log-fatal",error:"makeshift-serial-log-error",warn:"makeshift-serial-log-warn",deviceEvent:"makeshift-serial-log-event",info:"makeshift-serial-log-info",debug:"makeshift-serial-log-debug",all:"makeshift-serial-log-any"}},Ye={...$e,DEVICE:{CONNECTION_ERROR:"makeshift-connection-error",DISCONNECTED:"makeshift-disconnect",CONNECTED:"makeshift-connect",STATE_UPDATE:"state-update"}};let Fe=0;var Ue;!function(e){e[e.PING=0]="PING",e[e.ACK=1]="ACK",e[e.READY=2]="READY",e[e.STATE_UPDATE=3]="STATE_UPDATE",e[e.ERROR=4]="ERROR",e[e.STRING=5]="STRING",e[e.DISCONNECT=6]="DISCONNECT"}(Ue||(Ue={}));const Ve={portInfo:{},logLevel:"all",id:"",showTime:!1};class He extends n{serialPort;slipEncoder=new g.SlipEncoder(Qe);slipDecoder=new g.SlipDecoder(Qe);_prevAckTime=0;prevState={buttons:[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],dials:[0,0,0,0],dialsRelative:[0,0,0,0]};_deviceReady=!1;_id="";_portInfo=null;_msger;keepAliveTimer;static get connectedDevices(){return Fe}get prevAckTime(){return this._prevAckTime}get isOpen(){return void 0!==this.serialPort&&this.serialPort.isOpen}get devicePath(){return null!==this._portInfo?this._portInfo.path:""}get deviceSerial(){return this._id}get fingerPrint(){return{devicePath:this.devicePath,deviceSerial:this.deviceSerial,portId:this.portId}}get portInfo(){return this._portInfo}get portId(){return null!==this._portInfo?this._portInfo.serialNumber:""}log;debug;deviceEvent;info;warn;error;fatal;get host(){let e="Port:"+De.green((t=this.devicePath,t.match(se)?.[2]))+"|";var t;return this._deviceReady?e+=De.magenta(this.deviceSerial.slice(0,4)):e+=De.yellow("D/C"),e}_logLevel="all";get showTime(){return this._msger.showTime}set showTime(e){this._msger.showTime=e}get logLevel(){return this._logLevel}set logLevel(e){this._logLevel=e,this._msger.logLevel=e}get logTermFormat(){return this._msger.terminal}set logTermFormat(e){this._msger.terminal=e}emitLog=(e,t)=>{this.emit(Ge.Log[t],{level:t,message:e,buffer:l.from(e)})};constructor(e){super();const t=ke(e,Ve);this._portInfo=t.portInfo,this._msger=new ie,this._msger.host=this.host,this._msger.showTime=t.showTime,this.log=this._msger.getLevelLoggers(),this.logLevel=t.logLevel;for(const e in this.log)this[e]=t=>{const r=this.log[e](t);this.emitLog(r,e)};this.debug("Creating new MakeShiftPort with options: "+oe(t)),this.slipDecoder.on("data",(e=>{this.parseSlipPacketHeader(e)})),this.open()}parseSlipPacketHeader(e){this._prevAckTime=Date.now();const t=e.subarray(0,1).at(0),r=e.subarray(1);switch(this.debug(e),t){case Ue.STATE_UPDATE:{let e=He.parseStateFromBuffer(r);this.emit(Ye.DEVICE.STATE_UPDATE,e),this.debug("state updating"),this.handleStateUpdate(e);break}case Ue.ACK:this.debug("Got ACK from MakeShift");break;case Ue.STRING:this.debug(r.toString());break;case Ue.PING:this.debug("Got PING from MakeShift, responding with ACK"),this.sendByte(Ue.ACK);break;case Ue.ERROR:this.debug("Got ERROR from MakeShift");break;case Ue.READY:this.debug("Got READY from MakeShift"),this.debug(r.toString()),Fe++,this._deviceReady=!0,this._id=r.toString().replaceAll("-",""),this._msger.host=this.host,this._prevAckTime=Date.now(),this.deviceEvent("Device connection established"),this.emit(Ye.DEVICE.CONNECTED,this.fingerPrint);break;default:this.debug(t),this.debug(e.toString())}}ping(){this.sendByte(Ue.PING)}handleStateUpdate(e){this.debug("Handling state update");for(let t=0;t<Ke;t++)if(e.buttons[t]!=this.prevState.buttons[t]){let r;r=!0===e.buttons[t]?Ye.BUTTON[t].PRESSED:Ye.BUTTON[t].RELEASED,this.emit(r,{state:e,event:r}),this.deviceEvent(`${r} with state ${e.buttons[t]}`)}for(let t=0;t<We;t++)if(e.dials[t],this.prevState.dials[t],0!==e.dialsRelative[t]){let r;this.emit(Ye.DIAL[t].CHANGED,{state:e,event:r}),r=e.dialsRelative[t]>0?Ye.DIAL[t].INCREMENT:Ye.DIAL[t].DECREMENT,this.emit(r,{state:e,event:r}),this.deviceEvent(`${r} with state ${e.dials[t]}`)}this.prevState=e}sendByte(e){if(this.isOpen)try{this.serialPort.flush();let t=l.from([e]);this.debug(`Sending byte: ${oe(t)}`),this.slipEncoder.write(t)}catch(e){this.error(e)}}send(e,t){if(this.isOpen)try{this.serialPort.flush();let r=l.from([e]),o=l.from(t);const i=l.concat([r,o]);this.debug(`Sending buffer: ${oe(i)}`),this.slipEncoder.write(i)}catch(e){this.error(e)}}static parseStateFromBuffer(e){let t={buttons:[],dials:[],dialsRelative:[]};const r=e.subarray(0,2).reverse(),o=e.subarray(2,6),i=e.subarray(6);function s(e,r){0!==r&&(e%2?t.buttons.push(!0):t.buttons.push(!1),s(Math.floor(e/2),r-1))}r.forEach((e=>s(e,8)));for(let e=0;e<4;e++)t.dialsRelative.push(o.readInt8(e));return t.dials.push(i.readInt32BE(0)),t.dials.push(i.readInt32BE(4)),t.dials.push(i.readInt32BE(8)),t.dials.push(i.readInt32BE(12)),t}async open(){this.serialPort=await new e({path:this.devicePath,baudRate:42069},(e=>{null!=e?(this.error("Something happened while opening port: "),this.error(e),this.emit(Ye.DEVICE.CONNECTION_ERROR,e)):(this._msger.host=this.host,this.info("SerialPort opened, attaching SLIP translators"),this.slipEncoder.pipe(this.serialPort),this.serialPort.pipe(this.slipDecoder),this.info("Translators ready, sending READY to MakeShift"),this.sendByte(Ue.READY))}))}close(){this.info("Closing MakeShift port..."),this.info("Unpiping encoders"),this.slipEncoder.unpipe(),this.serialPort.unpipe(),this.isOpen&&(this.info("Port object found open"),this.info("Sending disconnect packet"),this.sendByte(Ue.DISCONNECT),this.info("Closing port"),this.serialPort.close()),this._msger.host=this.host,Fe--,this._deviceReady=!1,this.warn("Port closed, sending disconnect signal"),this.emit(Ye.DEVICE.DISCONNECTED,this.fingerPrint)}write=e=>{this._deviceReady?this.send(Ue.STRING,e):this.info("MakeShift not ready, line not sent")}}const Ke=Ye.BUTTON.length,We=Ye.DIAL.length,Qe={ESC:219,END:192,ESC_END:220,ESC_ESC:221},Je={};let Xe=[];const qe=new n;let ze="info",Ze=!1,et=!0,tt=1e3,rt=5e3,ot=1500;const it={},st=new ie({host:"PortAuthority",logLevel:"info",showTime:!1});st.logLevel=ze,st.showTime=Ze;const nt=st.getLevelLoggers();function lt(){et=!0,pt()}function at(){et=!1}function ct(){et=!1,mt()}function ht(){return Xe}function ut(e){Ze=e,st.showTime=e;for(const t in Je)Je[t].showTime=e}function ft(e){ze=e,st.logLevel=e;for(const t in Je)Je[t].logLevel=e}function gt(e,t){void 0!==Je[e]&&(Je[e].logLevel=t)}function dt(e){st.logLevel=e}function pt(){setTimeout((()=>{mt()}),tt),qe.emit(Tt.scan.started)}function bt(e){it[e]=setTimeout((()=>{!function(e){const t=Date.now()-Je[e].prevAckTime;nt.debug(`elapsedTime since prevAckTime: ${t}`),t>rt?(clearTimeout(it[e]),nt.debug(`Timer handle - ${it[e]}`),nt.warn(`Device ${e}::${Je[e].devicePath} unresponsive for ${rt}ms, disconnecting`),function(e){if(void 0===Je[e])return;const t=Je[e].fingerPrint;Xe=Xe.filter((e=>t.devicePath!==e.devicePath&&t.deviceSerial!==e.deviceSerial)),Je[e].close(),delete Je[e],qe.emit(Tt.port.closed,t)}(e)):(t>=ot-40&&Je[e].ping(),bt(e))}(e)}),ot)}async function mt(){nt.debug(`scanForDevice called with autoscan set to ${et}`);try{const t=await e.list();t.forEach((e=>{nt.debug(re(e,1))}));const r=t.filter((e=>("16c0"===e.vendorId||"16C0"===e.vendorId)&&"0483"===e.productId));nt.debug(`Found MakeShift devices: ${oe(r)}`),r.length>0&&r.forEach((e=>{!function(e){const t=e.path;for(const e in Je)if(Je[e].devicePath===t)return;const r={portInfo:e,logLevel:ze,showTime:Ze};nt.info(`Opening device with options: '${re(r,1)}'`);let o=new He(r);o.once(Ye.DEVICE.CONNECTED,(e=>{const t=e.deviceSerial;Je[t]=o,Xe.push(e),Je[t].ping(),bt(t),nt.deviceEvent(`Opened port ${e.devicePath}, with deviceSerial ${De.magenta(e.deviceSerial)}`),qe.emit(Tt.port.opened,e)})),o.once(Ye.DEVICE.CONNECTION_ERROR,(e=>{nt.error(`Error opening device on port ${t}: ${e.message}`)}))}(e)})),et?pt():qe.emit(Tt.scan.stopped)}catch(e){nt.error(e)}}const Tt={port:{opened:"makeshift-pa-port-opened",closed:"makeshift-pa-port-closed"},scan:{started:"makeshift-pa-scan-started",stopped:"makeshift-pa-scan-stopped"}};export{Ye as DeviceEvents,He as MakeShiftPort,Ue as PacketType,qe as PortAuthority,Tt as PortAuthorityEvents,Je as Ports,Ge as SerialEvents,Ve as defaultMakeShiftPortOptions,ht as getPortFingerPrintSnapShot,tt as scanDelayMs,ct as scanOnce,ft as setLogLevel,dt as setPortAuthorityLogLevel,gt as setPortLogLevel,ut as setShowTime,lt as startAutoScan,at as stopAutoScan};
