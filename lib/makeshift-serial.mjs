import{SerialPort as e}from"serialport";import t from"stream";import{inspect as i}from"node:util";import o from"node:process";import n from"node:os";import s from"node:tty";import{EventEmitter as r}from"node:events";import{Buffer as l}from"node:buffer";import{randomFillSync as a}from"crypto";var c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},h={},u={};Object.defineProperty(u,"__esModule",{value:!0}),u.SlipDecoder=void 0;const f=t;class E extends f.Transform{constructor(e={}){super(e);const{START:t,ESC:i=219,END:o=192,ESC_START:n,ESC_END:s=220,ESC_ESC:r=221}=e;this.opts={START:t,ESC:i,END:o,ESC_START:n,ESC_END:s,ESC_ESC:r},this.buffer=Buffer.alloc(0),this.escape=!1,this.start=!1}_transform(e,t,i){for(let t=0;t<e.length;t++){let i=e[t];if(i!==this.opts.START){if(null==this.opts.START&&(this.start=!0),this.escape)i===this.opts.ESC_START&&this.opts.START?i=this.opts.START:i===this.opts.ESC_ESC?i=this.opts.ESC:i===this.opts.ESC_END?i=this.opts.END:(this.escape=!1,this.push(this.buffer),this.buffer=Buffer.alloc(0));else{if(i===this.opts.ESC){this.escape=!0;continue}if(i===this.opts.END){this.push(this.buffer),this.buffer=Buffer.alloc(0),this.escape=!1,this.start=!1;continue}}this.escape=!1,this.start&&(this.buffer=Buffer.concat([this.buffer,Buffer.from([i])]))}else this.start=!0}i()}_flush(e){this.push(this.buffer),this.buffer=Buffer.alloc(0),e()}}u.SlipDecoder=E;var d={};Object.defineProperty(d,"__esModule",{value:!0}),d.SlipEncoder=void 0;const g=t;class p extends g.Transform{constructor(e={}){super(e);const{START:t,ESC:i=219,END:o=192,ESC_START:n,ESC_END:s=220,ESC_ESC:r=221,bluetoothQuirk:l=!1}=e;this.opts={START:t,ESC:i,END:o,ESC_START:n,ESC_END:s,ESC_ESC:r,bluetoothQuirk:l}}_transform(e,t,i){const o=e.length;if(this.opts.bluetoothQuirk&&0===o)return i();const n=Buffer.alloc(2*o+2);let s=0;1==this.opts.bluetoothQuirk&&(n[s++]=this.opts.END),void 0!==this.opts.START&&(n[s++]=this.opts.START);for(let t=0;t<o;t++){let i=e[t];i===this.opts.START&&this.opts.ESC_START?(n[s++]=this.opts.ESC,i=this.opts.ESC_START):i===this.opts.END?(n[s++]=this.opts.ESC,i=this.opts.ESC_END):i===this.opts.ESC&&(n[s++]=this.opts.ESC,i=this.opts.ESC_ESC),n[s++]=i}n[s++]=this.opts.END,i(null,n.slice(0,s))}}var b,m,S;function T(e){return null!==e&&"object"==typeof e}function v(e,t,i=".",o){if(!T(t))return v(e,{},i,o);const n=Object.assign({},t);for(const t in e){if("__proto__"===t||"constructor"===t)continue;const s=e[t];null!=s&&(o&&o(n,t,s,i)||(Array.isArray(s)&&Array.isArray(n[t])?n[t]=s.concat(n[t]):T(s)&&T(n[t])?n[t]=v(s,n[t],(i?`${i}.`:"")+t.toString(),o):n[t]=s))}return n}d.SlipEncoder=p,b=h,m=c&&c.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),S=c&&c.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||m(t,e,i)},Object.defineProperty(b,"__esModule",{value:!0}),S(u,b),S(d,b);const C=(...e)=>e.reduce(((e,t)=>v(e,t,"",R)),{});var R;const A=(e=0)=>t=>`[${t+e}m`,_=(e=0)=>t=>`[${38+e};5;${t}m`,D=(e=0)=>(t,i,o)=>`[${38+e};2;${t};${i};${o}m`,N={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(N.modifier);Object.keys(N.color),Object.keys(N.bgColor);const O=function(){const e=new Map;for(const[t,i]of Object.entries(N)){for(const[t,o]of Object.entries(i))N[t]={open:`[${o[0]}m`,close:`[${o[1]}m`},i[t]=N[t],e.set(o[0],o[1]);Object.defineProperty(N,t,{value:i,enumerable:!1})}return Object.defineProperty(N,"codes",{value:e,enumerable:!1}),N.color.close="[39m",N.bgColor.close="[49m",N.color.ansi=A(),N.color.ansi256=_(),N.color.ansi16m=D(),N.bgColor.ansi=A(10),N.bgColor.ansi256=_(10),N.bgColor.ansi16m=D(10),Object.defineProperties(N,{rgbToAnsi256:{value:(e,t,i)=>e===t&&t===i?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(i/255*5),enumerable:!1},hexToRgb:{value(e){const t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(e.toString(16));if(!t)return[0,0,0];let[i]=t;3===i.length&&(i=[...i].map((e=>e+e)).join(""));const o=Number.parseInt(i,16);return[o>>16&255,o>>8&255,255&o]},enumerable:!1},hexToAnsi256:{value:e=>N.rgbToAnsi256(...N.hexToRgb(e)),enumerable:!1},ansi256ToAnsi:{value(e){if(e<8)return 30+e;if(e<16)return e-8+90;let t,i,o;if(e>=232)t=(10*(e-232)+8)/255,i=t,o=t;else{const n=(e-=16)%36;t=Math.floor(e/36)/5,i=Math.floor(n/6)/5,o=n%6/5}const n=2*Math.max(t,i,o);if(0===n)return 30;let s=30+(Math.round(o)<<2|Math.round(i)<<1|Math.round(t));return 2===n&&(s+=60),s},enumerable:!1},rgbToAnsi:{value:(e,t,i)=>N.ansi256ToAnsi(N.rgbToAnsi256(e,t,i)),enumerable:!1},hexToAnsi:{value:e=>N.ansi256ToAnsi(N.hexToAnsi256(e)),enumerable:!1}}),N}();function P(e,t=o.argv){const i=e.startsWith("-")?"":1===e.length?"-":"--",n=t.indexOf(i+e),s=t.indexOf("--");return-1!==n&&(-1===s||n<s)}const{env:w}=o;let y;function I(e,{streamIsTTY:t,sniffFlags:i=!0}={}){const s=function(){if("FORCE_COLOR"in w)return"true"===w.FORCE_COLOR?1:"false"===w.FORCE_COLOR?0:0===w.FORCE_COLOR.length?1:Math.min(Number.parseInt(w.FORCE_COLOR,10),3)}();void 0!==s&&(y=s);const r=i?y:s;if(0===r)return 0;if(i){if(P("color=16m")||P("color=full")||P("color=truecolor"))return 3;if(P("color=256"))return 2}if(e&&!t&&void 0===r)return 0;const l=r||0;if("dumb"===w.TERM)return l;if("win32"===o.platform){const e=n.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in w)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE","DRONE"].some((e=>e in w))||"codeship"===w.CI_NAME?1:l;if("TEAMCITY_VERSION"in w)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(w.TEAMCITY_VERSION)?1:0;if("TF_BUILD"in w&&"AGENT_NAME"in w)return 1;if("truecolor"===w.COLORTERM)return 3;if("TERM_PROGRAM"in w){const e=Number.parseInt((w.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(w.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(w.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(w.TERM)||"COLORTERM"in w?1:l}function L(e,t={}){return function(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}(I(e,{streamIsTTY:e&&e.isTTY,...t}))}P("no-color")||P("no-colors")||P("color=false")||P("color=never")?y=0:(P("color")||P("colors")||P("color=true")||P("color=always"))&&(y=1);const M={stdout:L({isTTY:s.isatty(1)}),stderr:L({isTTY:s.isatty(2)})};function B(e,t,i){let o=e.indexOf(t);if(-1===o)return e;const n=t.length;let s=0,r="";do{r+=e.slice(s,o)+t+i,s=o+n,o=e.indexOf(t,s)}while(-1!==o);return r+=e.slice(s),r}const{stdout:k,stderr:G}=M,j=Symbol("GENERATOR"),$=Symbol("STYLER"),x=Symbol("IS_EMPTY"),H=["ansi","ansi","ansi256","ansi16m"],U=Object.create(null),Y=e=>{const t=(...e)=>e.join(" ");return((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const i=k?k.level:0;e.level=void 0===t.level?i:t.level})(t,e),Object.setPrototypeOf(t,F.prototype),t};function F(e){return Y(e)}Object.setPrototypeOf(F.prototype,Function.prototype);for(const[e,t]of Object.entries(O))U[e]={get(){const i=z(this,W(t.open,t.close,this[$]),this[x]);return Object.defineProperty(this,e,{value:i}),i}};U.visible={get(){const e=z(this,this[$],!0);return Object.defineProperty(this,"visible",{value:e}),e}};const V=(e,t,i,...o)=>"rgb"===e?"ansi16m"===t?O[i].ansi16m(...o):"ansi256"===t?O[i].ansi256(O.rgbToAnsi256(...o)):O[i].ansi(O.rgbToAnsi(...o)):"hex"===e?V("rgb",t,i,...O.hexToRgb(...o)):O[i][e](...o),K=["rgb","hex","ansi256"];for(const e of K){U[e]={get(){const{level:t}=this;return function(...i){const o=W(V(e,H[t],"color",...i),O.color.close,this[$]);return z(this,o,this[x])}}};U["bg"+e[0].toUpperCase()+e.slice(1)]={get(){const{level:t}=this;return function(...i){const o=W(V(e,H[t],"bgColor",...i),O.bgColor.close,this[$]);return z(this,o,this[x])}}}}const Q=Object.defineProperties((()=>{}),{...U,level:{enumerable:!0,get(){return this[j].level},set(e){this[j].level=e}}}),W=(e,t,i)=>{let o,n;return void 0===i?(o=e,n=t):(o=i.openAll+e,n=t+i.closeAll),{open:e,close:t,openAll:o,closeAll:n,parent:i}},z=(e,t,i)=>{const o=(...e)=>J(o,1===e.length?""+e[0]:e.join(" "));return Object.setPrototypeOf(o,Q),o[j]=e,o[$]=t,o[x]=i,o},J=(e,t)=>{if(e.level<=0||!t)return e[x]?"":t;let i=e[$];if(void 0===i)return t;const{openAll:o,closeAll:n}=i;if(t.includes(""))for(;void 0!==i;)t=B(t,i.close,i.open),i=i.parent;const s=t.indexOf("\n");return-1!==s&&(t=function(e,t,i,o){let n=0,s="";do{const r="\r"===e[o-1];s+=e.slice(n,r?o-1:o)+t+(r?"\r\n":"\n")+i,n=o+1,o=e.indexOf("\n",n)}while(-1!==o);return s+=e.slice(n),s}(t,n,o,s)),o+t+n};Object.defineProperties(F.prototype,U);const X=F();function Z(e){return e.replace(/[^A-Za-z0-9]/g,"").toLowerCase().replace(/-(.)/g,(function(e,t){return t.toUpperCase()}))}F({level:G?G.level:0});const q={all:0,debug:1,info:2,deviceEvent:3,warn:4,error:5,fatal:98,none:99},ee={host:"",logLevel:"all",prompt:" => ",showTime:!0,symbol:{debug:"dbg",info:"",deviceEvent:"",warn:"(!)",error:"[!]",fatal:"{x_X}"},terminal:!0},te={debug:X.gray,info:X.white,deviceEvent:X.green,warn:X.yellow,error:X.red,fatal:X.redBright};function ie(e,t){te[e]=t}function oe(e){te.warn=e}function ne(e){return JSON.stringify(e,null,2)}function se(e,t){return i(e,{colors:!0,depth:t})}function re(e){return i(e,{colors:!0,depth:2})}class le{_debug=()=>{};_info=()=>{};_deviceEvent=()=>{};_warn=()=>{};_error=()=>{};_fatal=()=>{};_defaultLogger(e,t){console.log(e)}prompt=" => ";host="";logLevel="all";terminal=!0;showTime=!0;showMillis=!1;get time(){const e=new Date;let t="",i="",o="";e.getHours()<10&&(t="0"),e.getMinutes()<10&&(i="0"),e.getSeconds()<10&&(o="0"),t+=e.getHours(),i+=e.getMinutes(),o+=e.getSeconds();let n=t+":"+i+":"+o;return this.showMillis&&(n+=":"+e.getMilliseconds()),X.grey(n)}ps(e){let t="";return this.showTime&&(t+=this.time+" "),""!==this.symbol[e]&&(t+=te[e](this.symbol[e])+" "),t+=te[e](this.host)+this.prompt,t}symbol;assignOptions(e,t){for(const i in t)"object"!=typeof e[i]?e[i]=t[i]||e[i]:this.assignOptions(e[i],t[i])}getLevelLoggers(){return{debug:this._debug,info:this._info,deviceEvent:this._deviceEvent,warn:this._warn,error:this._error,fatal:this._fatal}}logger=this._defaultLogger;resetLogger(){this.logger=this._defaultLogger}constructor(e=ee){const t=C(e,ee);this.assignOptions(this,t),this.spawnLevelLoggers()}spawnLevelLoggers(){for(let e in this.symbol){let t=e;this["_"+e]=e=>{const i=`${this.ps(t)}${e}`;return q[this.logLevel]<=q[t]&&this.logger(i,t),i}}}}const ae=/(^|[\\/])([^\\/]+?)(?=(\.[^.]+)?$)/;let ce,he,ue=(e=21)=>{var t;t=e-=0,!ce||ce.length<t?(ce=Buffer.allocUnsafe(128*t),a(ce),he=0):he+t>ce.length&&(a(ce),he=0),he+=t;let i="";for(let t=he-e;t<he;t++)i+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&ce[t]];return i},fe=0;var Ee;!function(e){e[e.PING=0]="PING",e[e.ACK=1]="ACK",e[e.READY=2]="READY",e[e.STATE_UPDATE=3]="STATE_UPDATE",e[e.ERROR=4]="ERROR",e[e.STRING=5]="STRING",e[e.DISCONNECT=6]="DISCONNECT"}(Ee||(Ee={}));const de={portInfo:{},logLevel:"all",id:"",showTime:!1};class ge extends r{serialPort;slipEncoder=new h.SlipEncoder(Se);slipDecoder=new h.SlipDecoder(Se);_prevAckTime=0;prevState={buttons:[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],dials:[0,0,0,0]};_deviceReady=!1;_id="";_portInfo=null;_msger;keepAliveTimer;get prevAckTime(){return this._prevAckTime}get isOpen(){return void 0!==this.serialPort&&this.serialPort.isOpen}static get connectedDevices(){return fe}get devicePath(){return null!==this._portInfo?this._portInfo.path:""}get deviceSerial(){return null!==this._portInfo?this._portInfo.serialNumber:""}get fingerPrint(){return{devicePath:this.devicePath,deviceSerial:this.deviceSerial,portId:this.portId}}get portInfo(){return this._portInfo}get portId(){return this._id}log;debug;info;deviceEvent;warn;error;fatal;get host(){let e=`Port:${X.magenta(this.deviceSerial.slice(0,4))}|`;return this.isOpen?e+=X.green(this.devicePath.match(ae)?.[2]):e+=X.yellow("D/C"),e}_logLevel="all";get showTime(){return this._msger.showTime}set showTime(e){this._msger.showTime=e}get logLevel(){return this._logLevel}set logLevel(e){this._logLevel=e,this._msger.logLevel=e}get logTermFormat(){return this._msger.terminal}set logTermFormat(e){this._msger.terminal=e}emitLog=(e,t)=>{this.emit(pe.Terminal.Log[t],{level:t,message:e,buffer:l.from(e)})};constructor(e){super();const t=C(e,de);this._id=""===t.id?ue(23):t.id,this._portInfo=t.portInfo,this._msger=new le,this._msger.host=this.host,this._msger.showTime=t.showTime,this.log=this._msger.getLevelLoggers(),this.logLevel=t.logLevel;for(const e in this.log)this[e]=t=>{const i=this.log[e](t);this.emitLog(i,e)};this.debug("Creating new MakeShiftPort with options: "+re(t)),this.slipDecoder.on("data",(e=>{this.onSlipDecoderData(e)})),this.open()}onSlipDecoderData(e){this._prevAckTime=Date.now();const t=e.slice(0,1).at(0),i=e.slice(1);switch(this.debug(re(e)),t){case Ee.STATE_UPDATE:{let e=ge.parseStateFromBuffer(i);this.emit(pe.DEVICE.STATE_UPDATE,e),this.onStateUpdate(e);break}case Ee.ACK:this.debug("Got ACK from MakeShift");break;case Ee.STRING:this.debug(i.toString());break;case Ee.PING:this.debug("Got PING from MakeShift, responding with ACK"),this.sendByte(Ee.ACK);break;case Ee.ERROR:this.debug("Got ERROR from MakeShift");break;case Ee.READY:this.debug("Got READY from MakeShift"),this.debug(i.toString()),fe++,this._deviceReady=!0,this._prevAckTime=Date.now(),this.deviceEvent("Device connection established"),this.emit(pe.DEVICE.CONNECTED,this.fingerPrint);break;default:this.debug(t),this.debug(e.toString())}}ping(){this.sendByte(Ee.PING)}onStateUpdate(e){for(let t=0;t<be;t++)if(e.buttons[t]!=this.prevState.buttons[t]){let i;i=!0===e.buttons[t]?pe.BUTTON[t].PRESSED:pe.BUTTON[t].RELEASED,this.emit(i,e.buttons[t]),this.deviceEvent(`${i} with state ${e.buttons[t]}`)}let t;for(let i=0;i<me;i++)if(t=this.prevState.dials[i]-e.dials[i],0!==t){let o;this.emit(pe.DIAL[i].CHANGE,e.dials[i]),o=t>0?pe.DIAL[i].INCREMENT:pe.DIAL[i].DECREMENT,this.emit(o,e.dials[i]),this.deviceEvent(`${o} with state ${e.dials[i]}`)}this.prevState=e}sendByte(e){if(this.isOpen)try{this.serialPort.flush();let t=l.from([e]);this.debug(`Sending byte: ${re(t)}`),this.slipEncoder.write(t)}catch(e){this.error(e)}}send(e,t){if(this.isOpen)try{this.serialPort.flush();let i=l.from([e]),o=l.from(t);const n=l.concat([i,o]);this.debug(`Sending buffer: ${re(n)}`),this.slipEncoder.write(n)}catch(e){this.error(e)}}static parseStateFromBuffer(e){let t={buttons:[],dials:[]};const i=e.slice(0,2).reverse(),o=e.slice(2,18);function n(e,i){0!==i&&(e%2?t.buttons.push(!0):t.buttons.push(!1),n(Math.floor(e/2),i-1))}return i.forEach((e=>n(e,8))),t.dials.push(o.readInt32BE(0)),t.dials.push(o.readInt32BE(4)),t.dials.push(o.readInt32BE(8)),t.dials.push(o.readInt32BE(12)),t}async open(){this.serialPort=await new e({path:this.devicePath,baudRate:42069},(e=>{null!=e?(this.error("Something happened while opening port: "),this.error(e)):(this._msger.host=this.host,this.info("SerialPort opened, attaching SLIP translators"),this.slipEncoder.pipe(this.serialPort),this.serialPort.pipe(this.slipDecoder),this.info("Translators ready, sending READY to MakeShift"),this.sendByte(Ee.READY))}))}close(){this.info("Closing MakeShift port..."),this.info("Unpiping encoders"),this.slipEncoder.unpipe(),this.serialPort.unpipe(),this.isOpen&&(this.info("Port object found open"),this.info("Sending disconnect packet"),this.sendByte(Ee.DISCONNECT),this.info("Closing port"),this.serialPort.close()),this._msger.host=this.host,fe--,this._deviceReady=!1,this.warn("Port closed, sending disconnect signal"),this.emit(pe.DEVICE.DISCONNECTED,this.fingerPrint)}write=e=>{this._deviceReady?this.send(Ee.STRING,e):this.info("MakeShift not ready, line not sent")}}const pe={DIAL:[{INCREMENT:"dial-01-increment",DECREMENT:"dial-01-decrement",CHANGE:"dial-01-change"},{INCREMENT:"dial-02-increment",DECREMENT:"dial-02-decrement",CHANGE:"dial-02-change"},{INCREMENT:"dial-03-increment",DECREMENT:"dial-03-decrement",CHANGE:"dial-03-change"},{INCREMENT:"dial-04-increment",DECREMENT:"dial-04-decrement",CHANGE:"dial-04-change"}],BUTTON:[{PRESSED:"button-01-rise",RELEASED:"button-01-fall",CHANGE:"button-01-change"},{PRESSED:"button-02-rise",RELEASED:"button-02-fall",CHANGE:"button-02-change"},{PRESSED:"button-03-rise",RELEASED:"button-03-fall",CHANGE:"button-03-change"},{PRESSED:"button-04-rise",RELEASED:"button-04-fall",CHANGE:"button-04-change"},{PRESSED:"button-05-rise",RELEASED:"button-05-fall",CHANGE:"button-05-change"},{PRESSED:"button-06-rise",RELEASED:"button-06-fall",CHANGE:"button-06-change"},{PRESSED:"button-07-rise",RELEASED:"button-07-fall",CHANGE:"button-07-change"},{PRESSED:"button-08-rise",RELEASED:"button-08-fall",CHANGE:"button-08-change"},{PRESSED:"button-09-rise",RELEASED:"button-09-fall",CHANGE:"button-09-change"},{PRESSED:"button-10-rise",RELEASED:"button-10-fall",CHANGE:"button-10-change"},{PRESSED:"button-11-rise",RELEASED:"button-11-fall",CHANGE:"button-11-change"},{PRESSED:"button-12-rise",RELEASED:"button-12-fall",CHANGE:"button-12-change"},{PRESSED:"button-13-rise",RELEASED:"button-13-fall",CHANGE:"button-13-change"},{PRESSED:"button-14-rise",RELEASED:"button-14-fall",CHANGE:"button-14-change"},{PRESSED:"button-15-rise",RELEASED:"button-15-fall",CHANGE:"button-15-change"},{PRESSED:"button-16-rise",RELEASED:"button-16-fall",CHANGE:"button-16-change"}],DEVICE:{DISCONNECTED:"makeshift-disconnect",CONNECTED:"makeshift-connect",STATE_UPDATE:"state-update"},Terminal:{Log:{fatal:"makeshift-serial-log-fatal",error:"makeshift-serial-log-error",warn:"makeshift-serial-log-warn",deviceEvent:"makeshift-serial-log-event",info:"makeshift-serial-log-info",debug:"makeshift-serial-log-debug",all:"makeshift-serial-log-any"}}},be=pe.BUTTON.length,me=pe.DIAL.length,Se={ESC:219,END:192,ESC_END:220,ESC_ESC:221},Te={};let ve=[];const Ce=new r;let Re="info",Ae=!1,_e=!0;const De={},Ne=new le({host:"PortAuthority",logLevel:"info"});Ne.logLevel=Re,Ne.showTime=Ae;const Oe=Ne.getLevelLoggers();function Pe(){_e=!0,Ge()}function we(){_e=!1}function ye(){_e=!1,$e()}function Ie(){return ve}function Le(e){Ae=e,Ne.showTime=e;for(const t in Te)Te[t].showTime=e}function Me(e){Re=e;for(const t in Te)Te[t].logLevel=e}function Be(e,t){void 0!==Te[e]&&(Te[e].logLevel=t)}function ke(e){Ne.logLevel=e}function Ge(){setTimeout((()=>{$e()}),1e3),Ce.emit(xe.scan.started)}function je(e){De[e]=setTimeout((()=>{!function(e){const t=Date.now()-Te[e].prevAckTime;Oe.debug(`elapsedTime since prevAckTime: ${t}`),t>5e3?(clearTimeout(De[e]),Oe.debug(`Timer handle - ${De[e]}`),Oe.warn(`Device ${e}::${Te[e].devicePath} unresponsive for 5000ms, disconnecting`),function(e){if(void 0!==Te[e]){const t=Te[e].fingerPrint;ve=ve.filter((e=>t.devicePath!==e.devicePath&&t.deviceSerial!==e.deviceSerial)),Te[e].close(),delete Te[e],Ce.emit(xe.port.closed,t)}}(e)):(t>=1460&&Te[e].ping(),je(e))}(e)}),1500)}async function $e(){Oe.debug(`scanForDevice called with scan set to ${_e}`);try{const t=await e.list();t.forEach((e=>{Oe.debug(se(e,1))}));const i=t.filter((e=>("16c0"===e.vendorId||"16C0"===e.vendorId)&&"0483"===e.productId));Oe.debug(`Found MakeShift devices: ${re(i)}`),i.length>0&&i.forEach((e=>{!function(e){const t=e.path;for(const e in Te)if(Te[e].devicePath===t)return;const i=e.serialNumber,o={portInfo:e,id:i,logLevel:Re,showTime:Ae};Oe.info(`Opening device with options: '${se(o,1)}'`),Te[i]=new ge(o);const n=Te[i].fingerPrint;ve.push(n),Te[i].ping(),je(i),Oe.deviceEvent(`Opened port: ${n.deviceSerial} | ${n.devicePath}`),Ce.emit(xe.port.opened,n)}(e)})),_e?Ge():Ce.emit(xe.scan.stopped)}catch(e){Oe.error(e)}}const xe={port:{opened:"makeshift-pa-port-opened",closed:"makeshift-pa-port-closed"},scan:{started:"makeshift-pa-scan-started",stopped:"makeshift-pa-scan-stopped"}};export{pe as DeviceEvents,ge as MakeShiftPort,le as Msg,Ee as PacketType,Ce as PortAuthority,xe as PortAuthorityEvents,Te as Ports,de as defaultMakeShiftPortOptions,ee as defaultMsgOptions,Z as filterName,Ie as getPortFingerPrintSnapShot,q as logRank,re as nspct2,se as nspect,ye as scanOnce,ie as setColorize,Me as setLogLevel,ke as setPortAuthorityLogLevel,Be as setPortLogLevel,Le as setShowTime,oe as setWarn,Pe as startAutoScan,we as stopAutoScan,ne as strfy};
